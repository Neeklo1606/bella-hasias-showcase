import{c as B,r as l,j as e,b as H,B as v,A as q,m as _,l as J,s as R,t as Y}from"./index-LVCzZBFt.js";import{I as T,D as K,a as Q,b as X,c as Z,L as F,e as ee}from"./label-BsaR7ijS.js";import{S as A,a as M,b as I,c as E,d as D,P as se,T as te,A as ae,e as le,f as re,g as ne,h as ce,i as oe,j as ie,k as de}from"./alert-dialog-Dvt3fn7b.js";import{S as ue}from"./index-BnWSyGdw.js";import{C as me,b as xe,d as he}from"./card-Cf70q5zp.js";import{s as pe,i as ge,d as fe,g as je,u as ve}from"./use-resolved-media-BLl9ynrQ.js";import"./check-KzHrZiou.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=B("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),L=["Услуги","Кейсы","Баннеры","Главная страница","Прочее"],ye="image/jpeg,image/png,image/webp,video/mp4,video/webm",Ce=({onFilesSelected:s,disabled:o})=>{const n=l.useRef(null),[d,c]=l.useState(!1),m=l.useCallback(a=>{if(!(a!=null&&a.length))return;const w=Array.from(a).filter(p=>{var y;const N="."+((y=p.name.split(".").pop())==null?void 0:y.toLowerCase());return[".jpg",".jpeg",".png",".webp",".mp4",".webm"].includes(N)});w.length&&s(w)},[s]),g=l.useCallback(a=>{a.preventDefault(),c(!1),!o&&m(a.dataTransfer.files)},[m,o]),h=l.useCallback(a=>{a.preventDefault(),c(!0)},[]),b=l.useCallback(a=>{a.preventDefault(),a.currentTarget.contains(a.relatedTarget)||c(!1)},[]),u=()=>{var a;o||(a=n.current)==null||a.click()};return e.jsxs("div",{onDrop:g,onDragOver:h,onDragLeave:b,onClick:u,className:H("relative flex min-h-[140px] cursor-pointer flex-col items-center justify-center gap-2 rounded-xl border-2 border-dashed p-6 transition-colors","hover:border-primary/50 hover:bg-muted/50",d&&"border-primary bg-primary/5",o&&"cursor-not-allowed opacity-50"),children:[e.jsx("input",{ref:n,type:"file",multiple:!0,accept:ye,className:"sr-only",onChange:a=>{m(a.target.files),a.target.value=""}}),e.jsx("div",{className:"rounded-full bg-muted p-3",children:e.jsx(be,{className:"h-6 w-6 text-muted-foreground"})}),e.jsx("p",{className:"text-center text-sm font-medium text-foreground",children:"Перетащите файлы сюда или нажмите для выбора"}),e.jsx("p",{className:"text-center text-xs text-muted-foreground",children:"JPG, PNG, WebP, MP4, WebM"})]})},we=({search:s,onSearchChange:o,category:n,onCategoryChange:d})=>e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ue,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(T,{placeholder:"Поиск по имени, alt...",value:s,onChange:c=>o(c.target.value),className:"pl-9"})]}),e.jsxs(A,{value:n,onValueChange:d,children:[e.jsx(M,{className:"w-full sm:w-[200px]",children:e.jsx(I,{placeholder:"Категория"})}),e.jsxs(E,{children:[e.jsx(D,{value:"all",children:"Все категории"}),L.map(c=>e.jsx(D,{value:c,children:c},c))]})]})]}),Ne=s=>/\.(mp4|webm)$/i.test(s)||s.startsWith("data:video/"),De=({item:s,onEdit:o,onDelete:n,onCategoryChange:d})=>{const[c,m]=l.useState(!1),g=()=>{n(s.id),m(!1)};return e.jsxs(e.Fragment,{children:[e.jsxs(me,{className:"group overflow-hidden transition-shadow hover:shadow-md",children:[e.jsx(xe,{className:"p-0",children:e.jsx("div",{className:"relative aspect-square bg-muted",children:Ne(s.src)?e.jsx("video",{src:s.src,className:"h-full w-full object-cover",muted:!0,loop:!0,playsInline:!0,preload:"metadata"}):e.jsx("img",{src:s.src,alt:s.alt,className:"h-full w-full object-cover transition-transform group-hover:scale-105"})})}),e.jsxs(he,{className:"flex flex-col gap-3 border-t p-3",children:[e.jsx("p",{className:"line-clamp-2 text-sm font-medium",title:s.alt||s.filename,children:s.alt||s.filename}),e.jsxs(A,{value:s.category,onValueChange:h=>d(s.id,h),children:[e.jsx(M,{className:"h-8 text-xs",children:e.jsx(I,{})}),e.jsx(E,{children:L.map(h=>e.jsx(D,{value:h,children:h},h))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(v,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>o(s),children:[e.jsx(se,{className:"mr-1 h-3 w-3"}),"Редактировать"]}),e.jsx(v,{variant:"outline",size:"sm",className:"text-destructive hover:bg-destructive hover:text-destructive-foreground",onClick:()=>m(!0),children:e.jsx(te,{className:"h-3 w-3"})})]})]})]}),e.jsx(ae,{open:c,onOpenChange:m,children:e.jsxs(le,{children:[e.jsxs(re,{children:[e.jsx(ne,{children:"Удалить медиа?"}),e.jsxs(ce,{children:["Файл «",s.filename,"» будет удалён из медиатеки. Продолжить?"]})]}),e.jsxs(oe,{children:[e.jsx(ie,{children:"Отмена"}),e.jsx(de,{onClick:g,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Удалить"})]})]})})]})},Se=({items:s,onEdit:o,onDelete:n,onCategoryChange:d})=>e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5",children:e.jsx(q,{mode:"popLayout",children:s.map((c,m)=>e.jsx(_.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},transition:{duration:.2,delay:m*.02},layout:!0,children:e.jsx(De,{item:c,onEdit:o,onDelete:n,onCategoryChange:d})},c.id))})}),ke=({open:s,onOpenChange:o,item:n,onSave:d})=>{const[c,m]=l.useState(""),[g,h]=l.useState("Прочее");if(l.useEffect(()=>{n&&(m(n.alt),h(n.category))},[n]),!n)return null;const b=u=>{u.preventDefault(),d(n.id,{alt:c.trim()||n.alt,category:g}),o(!1)};return e.jsx(K,{open:s,onOpenChange:o,children:e.jsxs(Q,{className:"sm:max-w-[425px]",children:[e.jsx(X,{children:e.jsx(Z,{children:"Редактировать медиа"})}),e.jsxs("form",{onSubmit:b,className:"space-y-4",children:[e.jsx("div",{className:"sticky top-0 z-10 flex justify-end bg-background/95 py-2 backdrop-blur-sm",children:e.jsx(v,{type:"submit",size:"sm",children:"Сохранить"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"alt",children:"Alt-текст"}),e.jsx(T,{id:"alt",value:c,onChange:u=>m(u.target.value),placeholder:"Описание изображения"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"category",children:"Категория"}),e.jsxs(A,{value:g,onValueChange:u=>h(u),children:[e.jsx(M,{id:"category",children:e.jsx(I,{})}),e.jsx(E,{children:L.map(u=>e.jsx(D,{value:u,children:u},u))})]})]}),e.jsxs(ee,{className:"sticky bottom-0 bg-background pt-4",children:[e.jsx(v,{type:"button",variant:"outline",onClick:()=>o(!1),children:"Отмена"}),e.jsx(v,{type:"submit",children:"Сохранить"})]})]})]})})},Ae=()=>`m-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,Me=s=>/\.(mp4|webm)$/i.test(s),Ie=s=>new Promise((o,n)=>{const d=new FileReader;d.onload=()=>o(d.result),d.onerror=n,d.readAsDataURL(s)}),Pe=()=>{const[s,o]=l.useState([]),[n,d]=l.useState(""),[c,m]=l.useState("all"),[g,h]=l.useState(null),[b,u]=l.useState(!1);l.useEffect(()=>{o(J())},[]);const a=l.useCallback(r=>{o(r),R(r)},[]),w=l.useCallback(()=>{R(s),Y({title:"Сохранено",description:"Медиа обновлено в админке."})},[s]),[p,N]=l.useState({}),y=l.useRef(p);y.current=p;const O=l.useCallback(async r=>{const i=[],t={};for(const x of r){const j=Ae(),f=x.name,k=new Date().toISOString();if(Me(f)){const C=`/uploads/${f}`,W=URL.createObjectURL(x);t[j]=W,i.push({id:j,filename:f,src:C,category:"Прочее",alt:f.replace(/\.[^.]+$/,""),createdAt:k})}else try{const C=`idb://${j}`;await pe(j,x),i.push({id:j,filename:f,src:C,category:"Прочее",alt:f.replace(/\.[^.]+$/,""),createdAt:k})}catch{try{const C=await Ie(x);i.push({id:j,filename:f,src:C,category:"Прочее",alt:f.replace(/\.[^.]+$/,""),createdAt:k})}catch{continue}}}i.length&&(N(x=>({...x,...t})),a([...i,...s]))},[s,a]);l.useEffect(()=>()=>{Object.values(y.current).forEach(URL.revokeObjectURL)},[]);const P=l.useCallback(r=>{h(r),u(!0)},[]),$=l.useCallback((r,i)=>{a(s.map(t=>t.id===r?{...t,alt:i.alt,category:i.category}:t)),u(!1),h(null)},[s,a]),V=l.useCallback(r=>{const i=s.find(t=>t.id===r);i!=null&&i.src&&ge(i.src)&&fe(je(i.src)).catch(()=>{}),p[r]&&(URL.revokeObjectURL(p[r]),N(t=>{const x={...t};return delete x[r],x})),a(s.filter(t=>t.id!==r))},[s,a,p]),z=l.useCallback((r,i)=>{a(s.map(t=>t.id===r?{...t,category:i}:t))},[s,a]),U=ve(s),S=l.useMemo(()=>{let r=s;if(n.trim()){const t=n.trim().toLowerCase();r=r.filter(x=>x.filename.toLowerCase().includes(t)||x.alt.toLowerCase().includes(t))}c!=="all"&&(r=r.filter(t=>t.category===c));const i=new Map(U.map(t=>[t.id,t]));return[...r].map(t=>i.get(t.id)??t).sort((t,x)=>new Date(x.createdAt).getTime()-new Date(t.createdAt).getTime())},[s,U,n,c]),G=l.useMemo(()=>S.map(r=>p[r.id]?{...r,src:p[r.id]}:r),[S,p]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Медиа"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Загрузка и управление изображениями и видео"})]}),e.jsx(v,{onClick:w,children:"Сохранить"})]}),e.jsx(Ce,{onFilesSelected:O}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Изображения сохраняются в браузере. Видео (MP4, WebM) храните как файлы в ",e.jsx("code",{className:"rounded bg-muted px-1",children:"public/uploads/"})," — в админке указывайте имя файла, а предпросмотр появится в текущей сессии."]}),e.jsx(we,{search:n,onSearchChange:d,category:c,onCategoryChange:m}),e.jsx(Se,{items:G,onEdit:P,onDelete:V,onCategoryChange:z}),S.length===0&&e.jsx("p",{className:"py-12 text-center text-sm text-muted-foreground",children:s.length===0?"Нет медиа. Загрузите файлы выше.":"Нет результатов по фильтру."}),e.jsx(ke,{open:b,onOpenChange:u,item:g,onSave:$})]})};export{Pe as default};
