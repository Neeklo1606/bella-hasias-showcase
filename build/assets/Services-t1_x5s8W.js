import{j as e,e as U,B as f,r as d,f as $,g as D,A as J,h as L,s as y,m as X}from"./index-CJN8wZ_c.js";import{u as S}from"./useMutation-BeBgiuYR.js";import{D as Y,a as Z,b as ee,c as ae,I as b,e as se}from"./input-Beno2FK0.js";import{C as te,b as ie,d as le}from"./card-RitAKijZ.js";import{B as T,T as re}from"./TagsInput-DKbff6vD.js";import{I as ne}from"./image-BWIob5kO.js";import{P as ce,T as oe}from"./alert-dialog-CASNme4y.js";import{f as de,r as me}from"./ru-CVN3f-jD.js";import{L as p}from"./label-C1L8DSrz.js";import{T as ue}from"./popover-PCFSERS-.js";import{S as ge,a as he,b as xe,c as pe,d as fe,P as je}from"./Pagination-CasoZCso.js";import{M}from"./MediaSelect-DpAzQhXq.js";import{L as I,S as ve}from"./index-ClfnRtFj.js";import{P as ye,C as be}from"./ConfirmDialog-CI6Lmr-8.js";import{u as Ne}from"./use-resolved-media-CiwNyq6y.js";import"./check-DpHkC8Sa.js";const we=({service:i,mediaMap:m,onEdit:n,onDelete:c})=>{const u=m.get(i.imageId),l=i.category==="stylist"?"Стилист":i.category==="creator"?"Креатор":i.category;return e.jsx(U.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},transition:{duration:.2},layout:!0,children:e.jsxs(te,{className:"group overflow-hidden transition-shadow hover:shadow-md",children:[e.jsx(ie,{className:"p-0",children:e.jsx("div",{className:"relative aspect-[4/3] bg-muted",children:u&&!u.src.startsWith("data:video")?e.jsx("img",{src:u.src,alt:i.title,className:"h-full w-full object-cover transition-transform group-hover:scale-105"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:e.jsx(ne,{className:"h-12 w-12 text-muted-foreground/50"})})})}),e.jsxs(le,{className:"flex flex-col items-start gap-3 border-t p-4",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("h3",{className:"font-semibold truncate",children:i.title}),l&&e.jsx("div",{className:"mt-1.5",children:e.jsx(T,{variant:"outline",className:"text-xs",children:l})}),i.tags.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1",children:i.tags.slice(0,3).map(r=>e.jsx(T,{variant:"secondary",className:"text-xs",children:r},r))}),e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:["Обновлено:"," ",de(new Date(i.updatedAt),{addSuffix:!0,locale:me})]})]}),e.jsxs("div",{className:"flex w-full gap-2",children:[e.jsxs(f,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>n(i),children:[e.jsx(ce,{className:"mr-1 h-3 w-3"}),"Редактировать"]}),e.jsx(f,{variant:"outline",size:"sm",className:"text-destructive hover:bg-destructive hover:text-destructive-foreground",onClick:()=>c(i),children:e.jsx(oe,{className:"h-3 w-3"})})]})]})]})})},Ce=[{value:"stylist",label:"Стилист"},{value:"creator",label:"Креатор"}],E={title:"",description:"",category:"stylist",imageId:"",tags:[],ctaLabel:"",ctaLink:""},Le=({open:i,onOpenChange:m,service:n,mediaItems:c,onSubmit:u})=>{const[l,r]=d.useState(E),[h,g]=d.useState(!1);d.useEffect(()=>{var s;r(n?{title:n.title,description:n.description,category:n.category,imageId:n.imageId,coverId:n.coverId,tags:n.tags??[],ctaLabel:n.ctaLabel,ctaLink:n.ctaLink}:{...E,imageId:((s=c[0])==null?void 0:s.id)??""}),g(!1)},[n,c,i]);const j=async s=>{if(s.preventDefault(),!(!l.title.trim()||h)){!l.imageId&&c.length>0&&r(t=>({...t,imageId:c[0].id})),g(!0);try{await u(l),m(!1)}catch{}finally{g(!1)}}};return e.jsx(Y,{open:i,onOpenChange:m,children:e.jsxs(Z,{className:"max-h-[90vh] overflow-y-auto sm:max-w-[600px]",children:[e.jsx(ee,{children:e.jsx(ae,{children:n?"Редактировать услугу":"Новая услуга"})}),e.jsxs("form",{onSubmit:j,className:"space-y-4",children:[e.jsx("div",{className:"sticky top-0 z-10 flex justify-end bg-background/95 py-2 backdrop-blur-sm",children:e.jsxs(f,{type:"submit",size:"sm",disabled:h,children:[h&&e.jsx(I,{className:"mr-2 h-4 w-4 animate-spin"}),"Сохранить"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"title",children:"Заголовок *"}),e.jsx(b,{id:"title",value:l.title,onChange:s=>r(t=>({...t,title:s.target.value})),placeholder:"Название услуги",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"description",children:"Описание (Markdown)"}),e.jsx(ue,{id:"description",value:l.description,onChange:s=>r(t=>({...t,description:s.target.value})),placeholder:"Описание услуги. Поддерживается Markdown.",rows:4,className:"resize-none"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"category",children:"Категория"}),e.jsxs(ge,{value:l.category??"stylist",onValueChange:s=>r(t=>({...t,category:s})),children:[e.jsx(he,{id:"category",children:e.jsx(xe,{placeholder:"Выберите категорию"})}),e.jsx(pe,{children:Ce.map(s=>e.jsx(fe,{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Теги"}),e.jsx(re,{value:l.tags,onChange:s=>r(t=>({...t,tags:s}))})]}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsx(M,{label:"Превью (imageId)",value:l.imageId,onChange:s=>r(t=>({...t,imageId:s})),items:c,placeholder:"Выберите изображение"}),e.jsx(M,{label:"Обложка (опционально)",value:l.coverId??"",onChange:s=>r(t=>({...t,coverId:s||void 0})),items:c,placeholder:"Без обложки",allowEmpty:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"ctaLabel",children:"CTA — Подпись кнопки"}),e.jsx(b,{id:"ctaLabel",value:l.ctaLabel,onChange:s=>r(t=>({...t,ctaLabel:s.target.value})),placeholder:"Записаться"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"ctaLink",children:"CTA — Ссылка"}),e.jsx(b,{id:"ctaLink",value:l.ctaLink,onChange:s=>r(t=>({...t,ctaLink:s.target.value})),placeholder:"/services/stylist"})]}),e.jsxs(se,{className:"sticky bottom-0 bg-background pt-4",children:[e.jsx(f,{type:"button",variant:"outline",onClick:()=>m(!1),disabled:h,children:"Отмена"}),e.jsxs(f,{type:"submit",disabled:h,children:[h&&e.jsx(I,{className:"mr-2 h-4 w-4 animate-spin"}),"Сохранить"]})]})]})]})})},Be=()=>{const i=$(),[m,n]=d.useState(""),[c,u]=d.useState(1),[l,r]=d.useState(25),[h,g]=d.useState(!1),[j,s]=d.useState(null),[t,N]=d.useState(null),k={per_page:l,page:c,...m.trim()&&{q:m.trim()}},{data:x,isLoading:q}=D({queryKey:["services","admin",k],queryFn:()=>y.adminList(k),refetchOnWindowFocus:!1,retry:1}),{data:w,isLoading:A}=D({queryKey:["media","admin",{per_page:100}],queryFn:()=>X.adminList({per_page:100}),refetchOnWindowFocus:!1,retry:1}),P=(x==null?void 0:x.data)||[],K=(w==null?void 0:w.data)||[],_=q||A,v=x?{currentPage:x.current_page,lastPage:x.last_page,perPage:x.per_page,total:x.total}:null,C=Ne(K),Q=d.useMemo(()=>new Map(C.map(a=>[a.id,a])),[C]),z=()=>{s(null),g(!0)},O=a=>{s(a),g(!0)},B=S({mutationFn:a=>y.adminCreate({title:a.title,description:a.description,category:a.category,imageId:a.imageId?Number(a.imageId):void 0,coverId:a.coverId?Number(a.coverId):void 0,tags:a.tags||[],ctaLabel:a.ctaLabel,ctaLink:a.ctaLink,status:"published"}),onSuccess:()=>{i.invalidateQueries({queryKey:["services","admin"]}),L.success("Услуга создана"),g(!1),s(null)}}),V=S({mutationFn:({id:a,data:o})=>y.adminUpdate(a,{title:o.title,description:o.description,category:o.category,imageId:o.imageId?Number(o.imageId):void 0,coverId:o.coverId?Number(o.coverId):void 0,tags:o.tags||[],ctaLabel:o.ctaLabel,ctaLink:o.ctaLink}),onSuccess:()=>{i.invalidateQueries({queryKey:["services","admin"]}),L.success("Услуга обновлена"),g(!1),s(null)}}),W=S({mutationFn:a=>y.adminDelete(a),onSuccess:()=>{i.invalidateQueries({queryKey:["services","admin"]}),L.success("Услуга удалена"),N(null)}}),R=async a=>{j?await V.mutateAsync({id:Number(j.id),data:a}):await B.mutateAsync(a)},G=a=>{N(a)},H=()=>{t&&W.mutate(Number(t.id))},F=P;return _?e.jsxs("div",{className:"flex items-center justify-center min-h-screen",children:[e.jsx(I,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("div",{className:"text-sm text-muted-foreground ml-3",children:"Загрузка услуг..."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Услуги"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Управление услугами и связь с медиа"})]}),e.jsxs(f,{onClick:z,className:"w-fit",children:[e.jsx(ye,{className:"mr-2 h-4 w-4"}),"Добавить услугу"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ve,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(b,{placeholder:"Поиск по заголовку или тегам...",value:m,onChange:a=>{n(a.target.value),u(1)},onKeyDown:a=>{a.key==="Enter"&&i.invalidateQueries({queryKey:["services","admin"]})},className:"pl-9 max-w-md"})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4",children:e.jsx(J,{mode:"popLayout",children:F.map(a=>e.jsx(we,{service:a,mediaMap:Q,onEdit:O,onDelete:G},a.id))})}),F.length===0&&e.jsx("p",{className:"py-12 text-center text-sm text-muted-foreground",children:P.length===0?"Нет услуг. Добавьте первую.":"Нет результатов по поиску."}),v&&e.jsx(je,{currentPage:v.currentPage,lastPage:v.lastPage,perPage:v.perPage,total:v.total,onPageChange:a=>{u(a),window.scrollTo({top:0,behavior:"smooth"})},onPerPageChange:a=>{r(a),u(1)}}),e.jsx(Le,{open:h,onOpenChange:g,service:j,mediaItems:C,onSubmit:R}),e.jsx(be,{open:!!t,onOpenChange:a=>!a&&N(null),title:"Удалить услугу?",description:t?`Услуга «${t.title}» будет удалена. Продолжить?`:"",confirmLabel:"Удалить",cancelLabel:"Отмена",variant:"destructive",onConfirm:H})]})};export{Be as default};
