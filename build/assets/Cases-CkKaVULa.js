import{j as e,e as se,B as N,L as te,r as x,X as ae,b as ie,f as re,g as k,A as le,h as L,d as w,s as ne,m as oe}from"./index-Da8R1Z61.js";import{u as F}from"./useMutation-CDt2vLN2.js";import{D as ce,a as de,b as me,c as ue,I as M,e as pe}from"./input-BTvI3psF.js";import{C as he,b as xe,d as ge}from"./card-dk8wfevT.js";import{B as A,T as fe}from"./TagsInput-JeP69J_W.js";import{I as T}from"./image-5jGyfhrC.js";import{P as je,T as ve}from"./alert-dialog-1ZtB3lJG.js";import{E as ye}from"./external-link-C-la6VOy.js";import{f as Ne,r as be}from"./ru-CVN3f-jD.js";import{L as b}from"./label-w4nlHq8T.js";import{P as we,a as Ce,C as Se,b as Pe,c as Ie,d as ke,e as Le,f as Fe,g as De,h as Me,T as Te}from"./popover-CMCXCFyD.js";import{S as qe,a as Ee,b as _e,c as Ae,d as Ke,P as ze}from"./Pagination-DjkxDt4R.js";import{C as Oe}from"./check-Cj8ik3qq.js";import{L as q,S as $e}from"./index-BDzbB6h7.js";import{P as Qe,C as Be}from"./ConfirmDialog-DORCF9W4.js";import{u as Ve}from"./use-resolved-media-BXHrw9xP.js";const We=({caseItem:i,mediaMap:c,serviceMap:o,onEdit:j,onDelete:g})=>{const v=i.mediaIds[0],r=v?c.get(v):null,n=i.serviceId?o.get(i.serviceId):null,d=(r==null?void 0:r.src)&&/\.(mp4|webm)$/i.test(r.src);return e.jsx(se.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},transition:{duration:.2},layout:!0,children:e.jsxs(he,{className:"group overflow-hidden transition-shadow hover:shadow-md",children:[e.jsx(xe,{className:"p-0",children:e.jsxs("div",{className:"relative aspect-[4/3] bg-muted",children:[r&&!d?e.jsx("img",{src:r.src,alt:i.title,className:"h-full w-full object-cover transition-transform group-hover:scale-105"}):r&&d?e.jsx("video",{src:r.src,className:"h-full w-full object-cover",muted:!0,loop:!0,playsInline:!0,preload:"metadata"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:e.jsx(T,{className:"h-12 w-12 text-muted-foreground/50"})}),n&&e.jsx(A,{className:"absolute left-2 top-2",variant:"secondary",children:n.title})]})}),e.jsxs(ge,{className:"flex flex-col items-start gap-3 border-t p-4",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("h3",{className:"font-semibold truncate",children:i.title}),i.tags.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1",children:i.tags.slice(0,3).map(m=>e.jsx(A,{variant:"outline",className:"text-xs",children:m},m))}),e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:["Обновлено:"," ",Ne(new Date(i.updatedAt),{addSuffix:!0,locale:be})]})]}),e.jsxs("div",{className:"flex w-full gap-2",children:[e.jsxs(N,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>j(i),children:[e.jsx(je,{className:"mr-1 h-3 w-3"}),"Редактировать"]}),e.jsx(N,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(te,{to:`/portfolio/${i.slug}`,target:"_blank",children:[e.jsx(ye,{className:"mr-1 h-3 w-3"}),"Смотреть"]})}),e.jsx(N,{variant:"outline",size:"sm",className:"text-destructive hover:bg-destructive hover:text-destructive-foreground",onClick:()=>g(i),children:e.jsx(ve,{className:"h-3 w-3"})})]})]})]})})},D=i=>/\.(mp4|webm)$/i.test(i)||i.startsWith("data:video/"),Ue=({value:i,onChange:c,items:o,placeholder:j="Выберите медиа",label:g="Медиа",filterImagesOnly:v=!1})=>{const[r,n]=x.useState(!1),d=v?o.filter(a=>!D(a.src)):o,m=d.filter(a=>i.includes(a.id)),u=a=>{i.includes(a)?c(i.filter(f=>f!==a)):c([...i,a])},p=(a,f)=>{f.stopPropagation(),c(i.filter(t=>t!==a))};return e.jsxs("div",{className:"space-y-2",children:[g&&e.jsx("label",{className:"text-sm font-medium text-foreground",children:g}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[m.map(a=>e.jsxs("span",{className:"group relative inline-flex h-12 w-12 shrink-0 overflow-hidden rounded-md border bg-muted",children:[D(a.src)?e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:e.jsx(T,{className:"h-5 w-5 text-muted-foreground"})}):e.jsx("img",{src:a.src,alt:a.alt,className:"h-full w-full object-cover"}),e.jsx("button",{type:"button",onClick:f=>p(a.id,f),className:"absolute -right-1 -top-1 flex h-4 w-4 items-center justify-center rounded-full bg-destructive text-destructive-foreground opacity-0 transition-opacity group-hover:opacity-100","aria-label":"Удалить",children:e.jsx(ae,{className:"h-3 w-3"})})]},a.id)),e.jsxs(we,{open:r,onOpenChange:n,children:[e.jsx(Ce,{asChild:!0,children:e.jsx(N,{variant:"outline",size:"icon",className:"h-12 w-12 shrink-0",type:"button",children:e.jsx(Se,{className:"h-4 w-4"})})}),e.jsx(Pe,{className:"w-[320px] p-0",align:"start",children:e.jsxs(Ie,{children:[e.jsx(ke,{placeholder:"Поиск..."}),e.jsxs(Le,{children:[e.jsx(Fe,{children:"Медиа не найдено"}),e.jsx(De,{children:d.map(a=>e.jsxs(Me,{value:`${a.alt} ${a.filename}`,onSelect:()=>u(a.id),children:[e.jsx("span",{className:"relative mr-3 h-10 w-10 shrink-0 overflow-hidden rounded bg-muted",children:D(a.src)?e.jsx(T,{className:"absolute inset-0 m-auto h-5 w-5 text-muted-foreground"}):e.jsx("img",{src:a.src,alt:a.alt,className:"h-full w-full object-cover"})}),e.jsx("span",{className:"truncate flex-1",children:a.alt||a.filename}),e.jsx(Oe,{className:ie("h-4 w-4 shrink-0",i.includes(a.id)?"opacity-100":"opacity-0")})]},a.id))})]})]})})]})]}),m.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:j})]})},K=i=>i.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,""),z={title:"",slug:"",description:"",serviceId:"",mediaIds:[],tags:[]},Ge=({open:i,onOpenChange:c,caseItem:o,services:j,mediaItems:g,onSubmit:v})=>{const[r,n]=x.useState(z),[d,m]=x.useState(!1),[u,p]=x.useState(!1);x.useEffect(()=>{var t;o?(n({title:o.title,slug:o.slug,description:o.description,serviceId:o.serviceId,mediaIds:o.mediaIds??[],tags:o.tags??[]}),m(!0)):(n({...z,serviceId:((t=j[0])==null?void 0:t.id)??""}),m(!1)),p(!1)},[o,j,i]);const a=t=>{n(l=>({...l,title:t})),d||n(l=>({...l,slug:K(t)}))},f=async t=>{if(t.preventDefault(),!(!r.title.trim()||u)){r.slug.trim()||n(l=>({...l,slug:K(r.title)})),p(!0);try{await v(r),c(!1)}catch{}finally{p(!1)}}};return e.jsx(ce,{open:i,onOpenChange:c,children:e.jsxs(de,{className:"max-h-[90vh] overflow-y-auto sm:max-w-[600px]",children:[e.jsx(me,{children:e.jsx(ue,{children:o?"Редактировать кейс":"Новый кейс"})}),e.jsxs("form",{onSubmit:f,className:"space-y-4",children:[e.jsx("div",{className:"sticky top-0 z-10 flex justify-end bg-background/95 py-2 backdrop-blur-sm",children:e.jsxs(N,{type:"submit",size:"sm",disabled:u,children:[u&&e.jsx(q,{className:"mr-2 h-4 w-4 animate-spin"}),"Сохранить"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"title",children:"Заголовок *"}),e.jsx(M,{id:"title",value:r.title,onChange:t=>a(t.target.value),placeholder:"Название кейса",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"slug",children:"Slug (URL)"}),e.jsx(M,{id:"slug",value:r.slug,onChange:t=>{n(l=>({...l,slug:t.target.value})),m(!0)},placeholder:"editorial-portrait"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"description",children:"Описание (Markdown)"}),e.jsx(Te,{id:"description",value:r.description,onChange:t=>n(l=>({...l,description:t.target.value})),placeholder:"Описание кейса",rows:4,className:"resize-none"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Услуга"}),e.jsxs(qe,{value:r.serviceId,onValueChange:t=>n(l=>({...l,serviceId:t})),children:[e.jsx(Ee,{children:e.jsx(_e,{placeholder:"Выберите услугу"})}),e.jsx(Ae,{children:j.map(t=>e.jsx(Ke,{value:t.id,children:t.title},t.id))})]})]}),e.jsx(Ue,{label:"Медиа (изображения и видео)",value:r.mediaIds,onChange:t=>n(l=>({...l,mediaIds:t})),items:g,placeholder:"Добавьте изображения или видео"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Теги"}),e.jsx(fe,{value:r.tags,onChange:t=>n(l=>({...l,tags:t}))})]}),e.jsxs(pe,{className:"sticky bottom-0 bg-background pt-4",children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>c(!1),disabled:u,children:"Отмена"}),e.jsxs(N,{type:"submit",disabled:u,children:[u&&e.jsx(q,{className:"mr-2 h-4 w-4 animate-spin"}),"Сохранить"]})]})]})]})})},ds=()=>{const i=re(),[c,o]=x.useState(""),[j,g]=x.useState(1),[v,r]=x.useState(25),[n,d]=x.useState(!1),[m,u]=x.useState(null),[p,a]=x.useState(null),f={per_page:v,page:j,...c.trim()&&{q:c.trim()}},{data:t,isLoading:l}=k({queryKey:["cases","admin",f],queryFn:()=>w.adminList(f),refetchOnWindowFocus:!1,retry:1}),{data:C,isLoading:O}=k({queryKey:["services","admin",{per_page:100}],queryFn:()=>ne.adminList({per_page:100}),refetchOnWindowFocus:!1,retry:1}),{data:S,isLoading:$}=k({queryKey:["media","admin",{per_page:100}],queryFn:()=>oe.adminList({per_page:100}),refetchOnWindowFocus:!1,retry:1}),Q=(t==null?void 0:t.data)||[],P=(C==null?void 0:C.data)||[],B=(S==null?void 0:S.data)||[],E=l||O||$,y=t?{currentPage:t.current_page,lastPage:t.last_page,perPage:t.per_page,total:t.total}:null,I=Ve(B),V=useMemo(()=>new Map(I.map(s=>[s.id,s])),[I]),W=useMemo(()=>new Map(P.map(s=>[s.id,s])),[P]),U=()=>{u(null),d(!0)},G=F({mutationFn:s=>w.adminCreate({title:s.title,slug:s.slug,description:s.description,serviceId:s.serviceId?Number(s.serviceId):void 0,mediaIds:s.mediaIds?s.mediaIds.map(h=>Number(h)):[],tags:s.tags||[],status:s.status||"published"}),onSuccess:()=>{i.invalidateQueries({queryKey:["cases","admin"]}),L.success("Кейс создан"),d(!1),u(null)}}),H=F({mutationFn:({id:s,data:h})=>w.adminUpdate(s,{title:h.title,slug:h.slug,description:h.description,serviceId:h.serviceId?Number(h.serviceId):void 0,mediaIds:h.mediaIds?h.mediaIds.map(ee=>Number(ee)):[],tags:h.tags||[],status:h.status||"published"}),onSuccess:()=>{i.invalidateQueries({queryKey:["cases","admin"]}),L.success("Кейс обновлён"),d(!1),u(null)}}),X=F({mutationFn:s=>w.adminDelete(s),onSuccess:()=>{i.invalidateQueries({queryKey:["cases","admin"]}),L.success("Кейс удалён"),a(null)}}),J=s=>{u(s),d(!0)},R=async s=>{m?await H.mutateAsync({id:Number(m.id),data:s}):await G.mutateAsync(s)},Y=s=>{a(s)},Z=()=>{p&&X.mutate(Number(p.id))},_=Q;return E?e.jsxs("div",{className:"flex items-center justify-center min-h-screen",children:[e.jsx(q,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("div",{className:"text-sm text-muted-foreground ml-3",children:"Загрузка кейсов..."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Кейсы"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Управление портфолио и кейсами, связь с услугами"})]}),e.jsxs(N,{onClick:U,className:"w-fit",children:[e.jsx(Qe,{className:"mr-2 h-4 w-4"}),"Добавить кейс"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx($e,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(M,{placeholder:"Поиск по заголовку, slug или тегам...",value:c,onChange:s=>{o(s.target.value),g(1)},onKeyDown:s=>{s.key==="Enter"&&i.invalidateQueries({queryKey:["cases","admin"]})},className:"pl-9 max-w-md"})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4",children:e.jsx(le,{mode:"popLayout",children:_.map(s=>e.jsx(We,{caseItem:s,mediaMap:V,serviceMap:W,onEdit:J,onDelete:Y},s.id))})}),_.length===0&&!E&&e.jsx("p",{className:"py-12 text-center text-sm text-muted-foreground",children:(y==null?void 0:y.total)===0?"Нет кейсов. Добавьте первый.":"Нет результатов по поиску."}),y&&e.jsx(ze,{currentPage:y.currentPage,lastPage:y.lastPage,perPage:y.perPage,total:y.total,onPageChange:s=>{g(s),window.scrollTo({top:0,behavior:"smooth"})},onPerPageChange:s=>{r(s),g(1)}}),e.jsx(Ge,{open:n,onOpenChange:d,caseItem:m,services:P,mediaItems:I,onSubmit:R}),e.jsx(Be,{open:!!p,onOpenChange:s=>!s&&a(null),title:"Удалить кейс?",description:p?`Кейс «${p.title}» будет удалён. Продолжить?`:"",confirmLabel:"Удалить",cancelLabel:"Отмена",variant:"destructive",onConfirm:Z})]})};export{ds as default};
