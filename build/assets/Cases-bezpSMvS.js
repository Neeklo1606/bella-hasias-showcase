import{j as e,m as B,B as g,L as V,r as o,X as R,b as q,l as U,A as _}from"./index-CveXiIj1.js";import{D as G,a as H,b as W,c as X,L as w,I as y,e as J}from"./label-m5-LamLf.js";import{C as K,b as Q,d as Y}from"./card-BnWjYQKl.js";import{B as M,T as Z}from"./TagsInput-Dvg16SZM.js";import{I as S}from"./image-CROujZ1v.js";import{P as ee,T as se,S as te,a as ae,b as le,c as re,d as ie}from"./alert-dialog-BydVCKmt.js";import{E as ne}from"./external-link-DcX91PJF.js";import{f as oe,r as ce}from"./ru-CVN3f-jD.js";import{P as de,a as me,C as ue,b as he,c as xe,d as pe,e as fe,f as ge,g as je,h as ve,T as Ne}from"./popover-Dl_yWDdL.js";import{C as we}from"./check-OrtdR_M6.js";import{P as Ce,C as be}from"./ConfirmDialog-CT0APwhH.js";import{l as ye,s as Se}from"./casesStorage-C3t2rj2t.js";import{l as ke}from"./servicesStorage-BoZ-VFie.js";import{u as De}from"./use-resolved-media-CGzITu6-.js";import{S as Me}from"./index-DmKT2ZZj.js";const Le=({caseItem:t,mediaMap:d,serviceMap:i,onEdit:u,onDelete:p})=>{const f=t.mediaIds[0],l=f?d.get(f):null,n=t.serviceId?i.get(t.serviceId):null,h=(l==null?void 0:l.src)&&/\.(mp4|webm)$/i.test(l.src);return e.jsx(B.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},transition:{duration:.2},layout:!0,children:e.jsxs(K,{className:"group overflow-hidden transition-shadow hover:shadow-md",children:[e.jsx(Q,{className:"p-0",children:e.jsxs("div",{className:"relative aspect-[4/3] bg-muted",children:[l&&!h?e.jsx("img",{src:l.src,alt:t.title,className:"h-full w-full object-cover transition-transform group-hover:scale-105"}):l&&h?e.jsx("video",{src:l.src,className:"h-full w-full object-cover",muted:!0,loop:!0,playsInline:!0,preload:"metadata"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:e.jsx(S,{className:"h-12 w-12 text-muted-foreground/50"})}),n&&e.jsx(M,{className:"absolute left-2 top-2",variant:"secondary",children:n.title})]})}),e.jsxs(Y,{className:"flex flex-col items-start gap-3 border-t p-4",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("h3",{className:"font-semibold truncate",children:t.title}),t.tags.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1",children:t.tags.slice(0,3).map(c=>e.jsx(M,{variant:"outline",className:"text-xs",children:c},c))}),e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:["Обновлено:"," ",oe(new Date(t.updatedAt),{addSuffix:!0,locale:ce})]})]}),e.jsxs("div",{className:"flex w-full gap-2",children:[e.jsxs(g,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>u(t),children:[e.jsx(ee,{className:"mr-1 h-3 w-3"}),"Редактировать"]}),e.jsx(g,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(V,{to:`/portfolio/${t.slug}`,target:"_blank",children:[e.jsx(ne,{className:"mr-1 h-3 w-3"}),"Смотреть"]})}),e.jsx(g,{variant:"outline",size:"sm",className:"text-destructive hover:bg-destructive hover:text-destructive-foreground",onClick:()=>p(t),children:e.jsx(se,{className:"h-3 w-3"})})]})]})]})})},b=t=>/\.(mp4|webm)$/i.test(t)||t.startsWith("data:video/"),Te=({value:t,onChange:d,items:i,placeholder:u="Выберите медиа",label:p="Медиа",filterImagesOnly:f=!1})=>{const[l,n]=o.useState(!1),h=f?i.filter(s=>!b(s.src)):i,c=h.filter(s=>t.includes(s.id)),j=s=>{t.includes(s)?d(t.filter(r=>r!==s)):d([...t,s])},v=(s,r)=>{r.stopPropagation(),d(t.filter(N=>N!==s))};return e.jsxs("div",{className:"space-y-2",children:[p&&e.jsx("label",{className:"text-sm font-medium text-foreground",children:p}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[c.map(s=>e.jsxs("span",{className:"group relative inline-flex h-12 w-12 shrink-0 overflow-hidden rounded-md border bg-muted",children:[b(s.src)?e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:e.jsx(S,{className:"h-5 w-5 text-muted-foreground"})}):e.jsx("img",{src:s.src,alt:s.alt,className:"h-full w-full object-cover"}),e.jsx("button",{type:"button",onClick:r=>v(s.id,r),className:"absolute -right-1 -top-1 flex h-4 w-4 items-center justify-center rounded-full bg-destructive text-destructive-foreground opacity-0 transition-opacity group-hover:opacity-100","aria-label":"Удалить",children:e.jsx(R,{className:"h-3 w-3"})})]},s.id)),e.jsxs(de,{open:l,onOpenChange:n,children:[e.jsx(me,{asChild:!0,children:e.jsx(g,{variant:"outline",size:"icon",className:"h-12 w-12 shrink-0",type:"button",children:e.jsx(ue,{className:"h-4 w-4"})})}),e.jsx(he,{className:"w-[320px] p-0",align:"start",children:e.jsxs(xe,{children:[e.jsx(pe,{placeholder:"Поиск..."}),e.jsxs(fe,{children:[e.jsx(ge,{children:"Медиа не найдено"}),e.jsx(je,{children:h.map(s=>e.jsxs(ve,{value:`${s.alt} ${s.filename}`,onSelect:()=>j(s.id),children:[e.jsx("span",{className:"relative mr-3 h-10 w-10 shrink-0 overflow-hidden rounded bg-muted",children:b(s.src)?e.jsx(S,{className:"absolute inset-0 m-auto h-5 w-5 text-muted-foreground"}):e.jsx("img",{src:s.src,alt:s.alt,className:"h-full w-full object-cover"})}),e.jsx("span",{className:"truncate flex-1",children:s.alt||s.filename}),e.jsx(we,{className:q("h-4 w-4 shrink-0",t.includes(s.id)?"opacity-100":"opacity-0")})]},s.id))})]})]})})]})]}),c.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:u})]})},L=t=>t.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,""),T={title:"",slug:"",description:"",serviceId:"",mediaIds:[],tags:[]},Ie=({open:t,onOpenChange:d,caseItem:i,services:u,mediaItems:p,onSubmit:f})=>{const[l,n]=o.useState(T),[h,c]=o.useState(!1);o.useEffect(()=>{var s;i?(n({title:i.title,slug:i.slug,description:i.description,serviceId:i.serviceId,mediaIds:i.mediaIds??[],tags:i.tags??[]}),c(!0)):(n({...T,serviceId:((s=u[0])==null?void 0:s.id)??""}),c(!1))},[i,u,t]);const j=s=>{n(r=>({...r,title:s})),h||n(r=>({...r,slug:L(s)}))},v=s=>{s.preventDefault(),l.title.trim()&&(l.slug.trim()||n(r=>({...r,slug:L(l.title)})),f(l),d(!1))};return e.jsx(G,{open:t,onOpenChange:d,children:e.jsxs(H,{className:"max-h-[90vh] overflow-y-auto sm:max-w-[600px]",children:[e.jsx(W,{children:e.jsx(X,{children:i?"Редактировать кейс":"Новый кейс"})}),e.jsxs("form",{onSubmit:v,className:"space-y-4",children:[e.jsx("div",{className:"sticky top-0 z-10 flex justify-end bg-background/95 py-2 backdrop-blur-sm",children:e.jsx(g,{type:"submit",size:"sm",children:"Сохранить"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"title",children:"Заголовок *"}),e.jsx(y,{id:"title",value:l.title,onChange:s=>j(s.target.value),placeholder:"Название кейса",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"slug",children:"Slug (URL)"}),e.jsx(y,{id:"slug",value:l.slug,onChange:s=>{n(r=>({...r,slug:s.target.value})),c(!0)},placeholder:"editorial-portrait"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"description",children:"Описание (Markdown)"}),e.jsx(Ne,{id:"description",value:l.description,onChange:s=>n(r=>({...r,description:s.target.value})),placeholder:"Описание кейса",rows:4,className:"resize-none"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"Услуга"}),e.jsxs(te,{value:l.serviceId,onValueChange:s=>n(r=>({...r,serviceId:s})),children:[e.jsx(ae,{children:e.jsx(le,{placeholder:"Выберите услугу"})}),e.jsx(re,{children:u.map(s=>e.jsx(ie,{value:s.id,children:s.title},s.id))})]})]}),e.jsx(Te,{label:"Медиа (изображения и видео)",value:l.mediaIds,onChange:s=>n(r=>({...r,mediaIds:s})),items:p,placeholder:"Добавьте изображения или видео"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"Теги"}),e.jsx(Z,{value:l.tags,onChange:s=>n(r=>({...r,tags:s}))})]}),e.jsxs(J,{className:"sticky bottom-0 bg-background pt-4",children:[e.jsx(g,{type:"button",variant:"outline",onClick:()=>d(!1),children:"Отмена"}),e.jsx(g,{type:"submit",children:"Сохранить"})]})]})]})})},Ee=()=>`case-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,Xe=()=>{const[t,d]=o.useState([]),[i,u]=o.useState([]),[p,f]=o.useState([]),[l,n]=o.useState(""),[h,c]=o.useState(!1),[j,v]=o.useState(null),[s,r]=o.useState(null);o.useEffect(()=>{d(ye()),u(ke()),f(U())},[]);const N=o.useCallback(a=>{d(a),Se(a)},[]),C=De(p),I=o.useMemo(()=>new Map(C.map(a=>[a.id,a])),[C]),E=o.useMemo(()=>new Map(i.map(a=>[a.id,a])),[i]),A=()=>{v(null),c(!0)},P=a=>{v(a),c(!0)},F=a=>{const x=new Date().toISOString();N(j?t.map(m=>m.id===j.id?{...a,id:m.id,createdAt:m.createdAt,updatedAt:x}:m):[{...a,id:Ee(),createdAt:x,updatedAt:x},...t]),c(!1),v(null)},$=a=>{r(a)},z=()=>{s&&(N(t.filter(a=>a.id!==s.id)),r(null))},k=o.useMemo(()=>{let a=t;if(l.trim()){const x=l.trim().toLowerCase();a=a.filter(m=>{var D;return m.title.toLowerCase().includes(x)||m.slug.toLowerCase().includes(x)||((D=m.tags)==null?void 0:D.some(O=>O.toLowerCase().includes(x)))})}return[...a].sort((x,m)=>new Date(m.updatedAt).getTime()-new Date(x.updatedAt).getTime())},[t,l]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Кейсы"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Управление портфолио и кейсами, связь с услугами"})]}),e.jsxs(g,{onClick:A,className:"w-fit",children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Добавить кейс"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Me,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(y,{placeholder:"Поиск по заголовку, slug или тегам...",value:l,onChange:a=>n(a.target.value),className:"pl-9 max-w-md"})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4",children:e.jsx(_,{mode:"popLayout",children:k.map(a=>e.jsx(Le,{caseItem:a,mediaMap:I,serviceMap:E,onEdit:P,onDelete:$},a.id))})}),k.length===0&&e.jsx("p",{className:"py-12 text-center text-sm text-muted-foreground",children:t.length===0?"Нет кейсов. Добавьте первый.":"Нет результатов по поиску."}),e.jsx(Ie,{open:h,onOpenChange:c,caseItem:j,services:i,mediaItems:C,onSubmit:F}),e.jsx(be,{open:!!s,onOpenChange:a=>!a&&r(null),title:"Удалить кейс?",description:s?`Кейс «${s.title}» будет удалён. Продолжить?`:"",confirmLabel:"Удалить",cancelLabel:"Отмена",variant:"destructive",onConfirm:z})]})};export{Xe as default};
