import{r,j as e,b as m,a2 as S,g as C,B as U}from"./index-ClYFeCvH.js";import{I as W,D as z,a as Q,b as $,c as X,d as Y}from"./input-BS_m5nM-.js";import{S as D,a as A,b as _,c as I,d as i,P as Z}from"./Pagination-DeCstKBU.js";import{L as R,S as ee}from"./index-C_ZeLCdm.js";import{E as ae}from"./eye-CU_VHW0P.js";import"./check-DyWei0e8.js";const L=r.forwardRef(({className:t,...l},s)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:s,className:m("w-full caption-bottom text-sm",t),...l})}));L.displayName="Table";const k=r.forwardRef(({className:t,...l},s)=>e.jsx("thead",{ref:s,className:m("[&_tr]:border-b",t),...l}));k.displayName="TableHeader";const M=r.forwardRef(({className:t,...l},s)=>e.jsx("tbody",{ref:s,className:m("[&_tr:last-child]:border-0",t),...l}));M.displayName="TableBody";const se=r.forwardRef(({className:t,...l},s)=>e.jsx("tfoot",{ref:s,className:m("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",t),...l}));se.displayName="TableFooter";const p=r.forwardRef(({className:t,...l},s)=>e.jsx("tr",{ref:s,className:m("border-b transition-colors data-[state=selected]:bg-muted hover:bg-muted/50",t),...l}));p.displayName="TableRow";const x=r.forwardRef(({className:t,...l},s)=>e.jsx("th",{ref:s,className:m("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",t),...l}));x.displayName="TableHead";const o=r.forwardRef(({className:t,...l},s)=>e.jsx("td",{ref:s,className:m("p-4 align-middle [&:has([role=checkbox])]:pr-0",t),...l}));o.displayName="TableCell";const te=r.forwardRef(({className:t,...l},s)=>e.jsx("caption",{ref:s,className:m("mt-4 text-sm text-muted-foreground",t),...l}));te.displayName="TableCaption";const F={adminList:async t=>{const s=(await S.get("/api/admin/audit",{params:t})).data;return{data:s.data||[],current_page:s.current_page??1,last_page:s.last_page??1,per_page:s.per_page??25,total:s.total??0}},adminGet:async t=>(await S.get(`/api/admin/audit/${t}`)).data},oe=()=>{const[t,l]=r.useState(""),[s,O]=r.useState("all"),[j,E]=r.useState("all"),[q,u]=r.useState(1),[H,B]=r.useState(25),[d,V]=r.useState(null),[g,N]=r.useState(!1),v={per_page:H,page:q,...t.trim()&&{q:t.trim()},...s!=="all"&&{action:s},...j!=="all"&&{entity_type:j}},{data:c,isLoading:G}=C({queryKey:["audit","admin",v],queryFn:()=>F.adminList(v),refetchOnWindowFocus:!1,retry:1}),{data:n,isLoading:J}=C({queryKey:["audit","admin","detail",d==null?void 0:d.id],queryFn:()=>F.adminGet(d.id),enabled:!!d&&g,refetchOnWindowFocus:!1,retry:1}),y=(c==null?void 0:c.data)||[],K=G,h=c?{currentPage:c.current_page,lastPage:c.last_page,perPage:c.per_page,total:c.total}:null,b=a=>{V(a),N(!0)},w=a=>{const f=new Date(a);return new Intl.DateTimeFormat("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(f)},T=a=>a.replace("App\\Models\\","").replace(/\\/g,""),P={created:"Создано",updated:"Обновлено",deleted:"Удалено",uploaded:"Загружено"};return K?e.jsxs("div",{className:"flex items-center justify-center min-h-screen",children:[e.jsx(R,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("div",{className:"text-sm text-muted-foreground ml-3",children:"Загрузка логов..."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Журнал действий"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"История изменений в системе"})]})}),e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ee,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(W,{placeholder:"Поиск по типу сущности, имени или email пользователя...",value:t,onChange:a=>{l(a.target.value),u(1)},className:"pl-9"})]}),e.jsxs(D,{value:s,onValueChange:a=>{O(a),u(1)},children:[e.jsx(A,{className:"w-[180px]",children:e.jsx(_,{placeholder:"Действие"})}),e.jsxs(I,{children:[e.jsx(i,{value:"all",children:"Все действия"}),e.jsx(i,{value:"created",children:"Создано"}),e.jsx(i,{value:"updated",children:"Обновлено"}),e.jsx(i,{value:"deleted",children:"Удалено"}),e.jsx(i,{value:"uploaded",children:"Загружено"})]})]}),e.jsxs(D,{value:j,onValueChange:a=>{E(a),u(1)},children:[e.jsx(A,{className:"w-[200px]",children:e.jsx(_,{placeholder:"Тип сущности"})}),e.jsxs(I,{children:[e.jsx(i,{value:"all",children:"Все типы"}),e.jsx(i,{value:"App\\\\Models\\\\Service",children:"Service"}),e.jsx(i,{value:"App\\\\Models\\\\CaseItem",children:"CaseItem"}),e.jsx(i,{value:"App\\\\Models\\\\Page",children:"Page"}),e.jsx(i,{value:"App\\\\Models\\\\MediaFile",children:"MediaFile"})]})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(L,{children:[e.jsx(k,{children:e.jsxs(p,{children:[e.jsx(x,{children:"Дата"}),e.jsx(x,{children:"Пользователь"}),e.jsx(x,{children:"Действие"}),e.jsx(x,{children:"Тип сущности"}),e.jsx(x,{children:"ID сущности"}),e.jsx(x,{className:"w-[100px]",children:"Детали"})]})}),e.jsx(M,{children:y.length===0?e.jsx(p,{children:e.jsx(o,{colSpan:6,className:"text-center text-muted-foreground py-8",children:"Нет записей"})}):y.map(a=>e.jsxs(p,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>b(a),children:[e.jsx(o,{className:"font-mono text-sm",children:w(a.createdAt)}),e.jsx(o,{children:a.user?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.user.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:a.user.email})]}):e.jsx("span",{className:"text-muted-foreground",children:"—"})}),e.jsx(o,{children:e.jsx("span",{className:"inline-flex items-center rounded-full px-2 py-1 text-xs font-medium bg-primary/10 text-primary",children:P[a.action]||a.action})}),e.jsx(o,{className:"font-mono text-xs",children:T(a.entityType)}),e.jsx(o,{className:"font-mono text-sm",children:a.entityId||"—"}),e.jsx(o,{children:e.jsx(U,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),b(a)},children:e.jsx(ae,{className:"h-4 w-4"})})})]},a.id))})]})}),h&&e.jsx(Z,{currentPage:h.currentPage,lastPage:h.lastPage,perPage:h.perPage,total:h.total,onPageChange:a=>{u(a),window.scrollTo({top:0,behavior:"smooth"})},onPerPageChange:a=>{B(a),u(1)}}),e.jsx(z,{open:g,onOpenChange:N,children:e.jsxs(Q,{className:"max-w-3xl max-h-[80vh] overflow-y-auto",children:[e.jsxs($,{children:[e.jsx(X,{children:"Детали записи журнала"}),e.jsxs(Y,{children:["ID: ",d==null?void 0:d.id," | ",d&&w(d.createdAt)]})]}),J?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(R,{className:"h-6 w-6 animate-spin text-primary"})}):n?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"Пользователь"}),e.jsx("div",{className:"mt-1",children:n.user?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:n.user.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:n.user.email})]}):e.jsx("span",{className:"text-muted-foreground",children:"—"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"Действие"}),e.jsx("div",{className:"mt-1",children:e.jsx("span",{className:"inline-flex items-center rounded-full px-2 py-1 text-xs font-medium bg-primary/10 text-primary",children:P[n.action]||n.action})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"Тип сущности"}),e.jsx("div",{className:"mt-1 font-mono text-sm",children:T(n.entityType)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"ID сущности"}),e.jsx("div",{className:"mt-1 font-mono text-sm",children:n.entityId||"—"})]}),n.ip&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"IP адрес"}),e.jsx("div",{className:"mt-1 font-mono text-sm",children:n.ip})]}),n.userAgent&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"User Agent"}),e.jsx("div",{className:"mt-1 text-sm break-all",children:n.userAgent})]})]}),n.payload&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Payload (JSON)"}),e.jsx("pre",{className:"bg-muted p-4 rounded-md text-xs overflow-x-auto",children:JSON.stringify(n.payload,null,2)})]})]}):null]})})]})};export{oe as default};
