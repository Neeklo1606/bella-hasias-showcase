import{j as e,m as V,B as g,L as U,r as c,X as q,b as G,d as N,s as H,A as W}from"./index-SoIpdMiX.js";import{D as X,a as J,b as K,c as Q,L as w,I,e as Y}from"./label-8EU_9GcQ.js";import{C as Z,b as ee,d as se,m as te}from"./media.api-D7iI7wZ-.js";import{B as M,T as ae}from"./TagsInput-BXBut0BW.js";import{I as k}from"./image-B6N2rTep.js";import{P as le,T as re,S as ie,a as ne,b as oe,c as ce,d as de}from"./alert-dialog-CgQjXj0u.js";import{E as me}from"./external-link-J1gCqmRF.js";import{f as ue,r as he}from"./ru-CVN3f-jD.js";import{P as xe,a as pe,C as fe,b as ge,c as je,d as ve,e as Ne,f as we,g as be,h as Ce,T as ye}from"./popover-BTtr18gX.js";import{C as Se}from"./check-BwA_N4LL.js";import{P as Ie,C as ke}from"./ConfirmDialog-EHM-sfnQ.js";import{u as De}from"./use-resolved-media-CME_U08d.js";import{S as Le}from"./index-PFNOrb6V.js";const Te=({caseItem:a,mediaMap:m,serviceMap:i,onEdit:u,onDelete:x})=>{const p=a.mediaIds[0],l=p?m.get(p):null,n=a.serviceId?i.get(a.serviceId):null,h=(l==null?void 0:l.src)&&/\.(mp4|webm)$/i.test(l.src);return e.jsx(V.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},transition:{duration:.2},layout:!0,children:e.jsxs(Z,{className:"group overflow-hidden transition-shadow hover:shadow-md",children:[e.jsx(ee,{className:"p-0",children:e.jsxs("div",{className:"relative aspect-[4/3] bg-muted",children:[l&&!h?e.jsx("img",{src:l.src,alt:a.title,className:"h-full w-full object-cover transition-transform group-hover:scale-105"}):l&&h?e.jsx("video",{src:l.src,className:"h-full w-full object-cover",muted:!0,loop:!0,playsInline:!0,preload:"metadata"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:e.jsx(k,{className:"h-12 w-12 text-muted-foreground/50"})}),n&&e.jsx(M,{className:"absolute left-2 top-2",variant:"secondary",children:n.title})]})}),e.jsxs(se,{className:"flex flex-col items-start gap-3 border-t p-4",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("h3",{className:"font-semibold truncate",children:a.title}),a.tags.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1",children:a.tags.slice(0,3).map(d=>e.jsx(M,{variant:"outline",className:"text-xs",children:d},d))}),e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:["Обновлено:"," ",ue(new Date(a.updatedAt),{addSuffix:!0,locale:he})]})]}),e.jsxs("div",{className:"flex w-full gap-2",children:[e.jsxs(g,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>u(a),children:[e.jsx(le,{className:"mr-1 h-3 w-3"}),"Редактировать"]}),e.jsx(g,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(U,{to:`/portfolio/${a.slug}`,target:"_blank",children:[e.jsx(me,{className:"mr-1 h-3 w-3"}),"Смотреть"]})}),e.jsx(g,{variant:"outline",size:"sm",className:"text-destructive hover:bg-destructive hover:text-destructive-foreground",onClick:()=>x(a),children:e.jsx(re,{className:"h-3 w-3"})})]})]})]})})},S=a=>/\.(mp4|webm)$/i.test(a)||a.startsWith("data:video/"),Me=({value:a,onChange:m,items:i,placeholder:u="Выберите медиа",label:x="Медиа",filterImagesOnly:p=!1})=>{const[l,n]=c.useState(!1),h=p?i.filter(s=>!S(s.src)):i,d=h.filter(s=>a.includes(s.id)),j=s=>{a.includes(s)?m(a.filter(r=>r!==s)):m([...a,s])},f=(s,r)=>{r.stopPropagation(),m(a.filter(C=>C!==s))};return e.jsxs("div",{className:"space-y-2",children:[x&&e.jsx("label",{className:"text-sm font-medium text-foreground",children:x}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[d.map(s=>e.jsxs("span",{className:"group relative inline-flex h-12 w-12 shrink-0 overflow-hidden rounded-md border bg-muted",children:[S(s.src)?e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:e.jsx(k,{className:"h-5 w-5 text-muted-foreground"})}):e.jsx("img",{src:s.src,alt:s.alt,className:"h-full w-full object-cover"}),e.jsx("button",{type:"button",onClick:r=>f(s.id,r),className:"absolute -right-1 -top-1 flex h-4 w-4 items-center justify-center rounded-full bg-destructive text-destructive-foreground opacity-0 transition-opacity group-hover:opacity-100","aria-label":"Удалить",children:e.jsx(q,{className:"h-3 w-3"})})]},s.id)),e.jsxs(xe,{open:l,onOpenChange:n,children:[e.jsx(pe,{asChild:!0,children:e.jsx(g,{variant:"outline",size:"icon",className:"h-12 w-12 shrink-0",type:"button",children:e.jsx(fe,{className:"h-4 w-4"})})}),e.jsx(ge,{className:"w-[320px] p-0",align:"start",children:e.jsxs(je,{children:[e.jsx(ve,{placeholder:"Поиск..."}),e.jsxs(Ne,{children:[e.jsx(we,{children:"Медиа не найдено"}),e.jsx(be,{children:h.map(s=>e.jsxs(Ce,{value:`${s.alt} ${s.filename}`,onSelect:()=>j(s.id),children:[e.jsx("span",{className:"relative mr-3 h-10 w-10 shrink-0 overflow-hidden rounded bg-muted",children:S(s.src)?e.jsx(k,{className:"absolute inset-0 m-auto h-5 w-5 text-muted-foreground"}):e.jsx("img",{src:s.src,alt:s.alt,className:"h-full w-full object-cover"})}),e.jsx("span",{className:"truncate flex-1",children:s.alt||s.filename}),e.jsx(Se,{className:G("h-4 w-4 shrink-0",a.includes(s.id)?"opacity-100":"opacity-0")})]},s.id))})]})]})})]})]}),d.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:u})]})},F=a=>a.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,""),E={title:"",slug:"",description:"",serviceId:"",mediaIds:[],tags:[]},Fe=({open:a,onOpenChange:m,caseItem:i,services:u,mediaItems:x,onSubmit:p})=>{const[l,n]=c.useState(E),[h,d]=c.useState(!1);c.useEffect(()=>{var s;i?(n({title:i.title,slug:i.slug,description:i.description,serviceId:i.serviceId,mediaIds:i.mediaIds??[],tags:i.tags??[]}),d(!0)):(n({...E,serviceId:((s=u[0])==null?void 0:s.id)??""}),d(!1))},[i,u,a]);const j=s=>{n(r=>({...r,title:s})),h||n(r=>({...r,slug:F(s)}))},f=s=>{s.preventDefault(),l.title.trim()&&(l.slug.trim()||n(r=>({...r,slug:F(l.title)})),p(l),m(!1))};return e.jsx(X,{open:a,onOpenChange:m,children:e.jsxs(J,{className:"max-h-[90vh] overflow-y-auto sm:max-w-[600px]",children:[e.jsx(K,{children:e.jsx(Q,{children:i?"Редактировать кейс":"Новый кейс"})}),e.jsxs("form",{onSubmit:f,className:"space-y-4",children:[e.jsx("div",{className:"sticky top-0 z-10 flex justify-end bg-background/95 py-2 backdrop-blur-sm",children:e.jsx(g,{type:"submit",size:"sm",children:"Сохранить"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"title",children:"Заголовок *"}),e.jsx(I,{id:"title",value:l.title,onChange:s=>j(s.target.value),placeholder:"Название кейса",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"slug",children:"Slug (URL)"}),e.jsx(I,{id:"slug",value:l.slug,onChange:s=>{n(r=>({...r,slug:s.target.value})),d(!0)},placeholder:"editorial-portrait"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"description",children:"Описание (Markdown)"}),e.jsx(ye,{id:"description",value:l.description,onChange:s=>n(r=>({...r,description:s.target.value})),placeholder:"Описание кейса",rows:4,className:"resize-none"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"Услуга"}),e.jsxs(ie,{value:l.serviceId,onValueChange:s=>n(r=>({...r,serviceId:s})),children:[e.jsx(ne,{children:e.jsx(oe,{placeholder:"Выберите услугу"})}),e.jsx(ce,{children:u.map(s=>e.jsx(de,{value:s.id,children:s.title},s.id))})]})]}),e.jsx(Me,{label:"Медиа (изображения и видео)",value:l.mediaIds,onChange:s=>n(r=>({...r,mediaIds:s})),items:x,placeholder:"Добавьте изображения или видео"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"Теги"}),e.jsx(ae,{value:l.tags,onChange:s=>n(r=>({...r,tags:s}))})]}),e.jsxs(Y,{className:"sticky bottom-0 bg-background pt-4",children:[e.jsx(g,{type:"button",variant:"outline",onClick:()=>m(!1),children:"Отмена"}),e.jsx(g,{type:"submit",children:"Сохранить"})]})]})]})})},He=()=>{const[a,m]=c.useState([]),[i,u]=c.useState([]),[x,p]=c.useState([]),[l,n]=c.useState(""),[h,d]=c.useState(!1),[j,f]=c.useState(null),[s,r]=c.useState(null),[C,D]=c.useState(!0),b=c.useCallback(async()=>{try{D(!0);const[t,o,v]=await Promise.all([N.adminList({per_page:100}),H.adminList({per_page:100}),te.adminList({per_page:100})]);m(t.data),u(o.data),p(v.data)}catch(t){console.error("Failed to load cases:",t)}finally{D(!1)}},[]);c.useEffect(()=>{b()},[b]);const y=De(x),P=c.useMemo(()=>new Map(y.map(t=>[t.id,t])),[y]),A=c.useMemo(()=>new Map(i.map(t=>[t.id,t])),[i]),z=()=>{f(null),d(!0)},$=async t=>{try{const o=await N.adminGet(Number(t.id));f(o),d(!0)}catch(o){console.error("Failed to load case:",o),f(t),d(!0)}},R=async t=>{try{j?await N.adminUpdate(Number(j.id),{title:t.title,slug:t.slug,description:t.description,serviceId:t.serviceId?Number(t.serviceId):void 0,mediaIds:t.mediaIds?t.mediaIds.map(o=>Number(o)):[],tags:t.tags||[],status:t.status||"published"}):await N.adminCreate({title:t.title,slug:t.slug,description:t.description,serviceId:t.serviceId?Number(t.serviceId):void 0,mediaIds:t.mediaIds?t.mediaIds.map(o=>Number(o)):[],tags:t.tags||[],status:t.status||"published"}),d(!1),f(null),await b()}catch(o){console.error("Failed to save case:",o)}},_=t=>{r(t)},B=async()=>{if(s)try{await N.adminDelete(Number(s.id)),r(null),await b()}catch(t){console.error("Failed to delete case:",t)}},L=c.useMemo(()=>{let t=a;if(l.trim()){const o=l.trim().toLowerCase();t=t.filter(v=>{var T;return v.title.toLowerCase().includes(o)||v.slug.toLowerCase().includes(o)||((T=v.tags)==null?void 0:T.some(O=>O.toLowerCase().includes(o)))})}return[...t].sort((o,v)=>new Date(v.updatedAt).getTime()-new Date(o.updatedAt).getTime())},[a,l]);return C?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Загрузка..."})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Кейсы"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Управление портфолио и кейсами, связь с услугами"})]}),e.jsxs(g,{onClick:z,className:"w-fit",children:[e.jsx(Ie,{className:"mr-2 h-4 w-4"}),"Добавить кейс"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Le,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(I,{placeholder:"Поиск по заголовку, slug или тегам...",value:l,onChange:t=>n(t.target.value),className:"pl-9 max-w-md"})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4",children:e.jsx(W,{mode:"popLayout",children:L.map(t=>e.jsx(Te,{caseItem:t,mediaMap:P,serviceMap:A,onEdit:$,onDelete:_},t.id))})}),L.length===0&&e.jsx("p",{className:"py-12 text-center text-sm text-muted-foreground",children:a.length===0?"Нет кейсов. Добавьте первый.":"Нет результатов по поиску."}),e.jsx(Fe,{open:h,onOpenChange:d,caseItem:j,services:i,mediaItems:y,onSubmit:R}),e.jsx(ke,{open:!!s,onOpenChange:t=>!t&&r(null),title:"Удалить кейс?",description:s?`Кейс «${s.title}» будет удалён. Продолжить?`:"",confirmLabel:"Удалить",cancelLabel:"Отмена",variant:"destructive",onConfirm:B})]})};export{He as default};
