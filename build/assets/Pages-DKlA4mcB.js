import{c as G,r as x,f as Z,g as ee,h as Y,m as H,j as e,i as te,k as se,l as ne,B as v,L as ae,A as U,p as T,t as O}from"./index-SoIpdMiX.js";import{D as A,a as R,b as B,c as P,e as K,L as N,I as L}from"./label-8EU_9GcQ.js";import{C as re,b as ie,d as le,m as ce}from"./media.api-D7iI7wZ-.js";import{F as oe}from"./file-text-D4jgvzik.js";import{P as q,C as de,l as ue,T as me,S as he,a as xe,b as fe,c as pe,d as ge}from"./alert-dialog-CgQjXj0u.js";import{E as je}from"./external-link-J1gCqmRF.js";import{f as ve,r as ye}from"./ru-CVN3f-jD.js";import{T as z}from"./popover-BTtr18gX.js";import{M as we}from"./MediaSelect-CKeC3GCU.js";import{P as J,C as Ne}from"./ConfirmDialog-EHM-sfnQ.js";import{u as Se}from"./use-resolved-media-CME_U08d.js";import"./index-PFNOrb6V.js";import"./check-BwA_N4LL.js";import"./image-B6N2rTep.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=G("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=G("Eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=G("GripVertical",[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]]),Q=x.createContext(null);function Le(t,r,i,u){if(!u)return t;const s=t.findIndex(n=>n.value===r);if(s===-1)return t;const o=u>0?1:-1,d=t[s+o];if(!d)return t;const m=t[s],c=d.layout,h=Z(c.min,c.max,.5);return o===1&&m.layout.max+i>h||o===-1&&m.layout.min+i<h?ee(t,s,s+o):t}function Ee({children:t,as:r="ul",axis:i="y",onReorder:u,values:s,...o},d){const m=Y(()=>H[r]),c=[],h=x.useRef(!1),n=x.useRef(null),p={axis:i,groupRef:n,registerItem:(w,b)=>{const S=c.findIndex(g=>w===g.value);S!==-1?c[S].layout=b[i]:c.push({value:w,layout:b[i]}),c.sort(Me)},updateOrder:(w,b,S)=>{if(h.current)return;const g=Le(c,w,b,S);c!==g&&(h.current=!0,u(g.map(Ie).filter(C=>s.indexOf(C)!==-1)))}};x.useEffect(()=>{h.current=!1});const y=w=>{n.current=w,typeof d=="function"?d(w):d&&(d.current=w)},j={overflowAnchor:"none",...o.style};return e.jsx(m,{...o,style:j,ref:y,ignoreStrict:!0,children:e.jsx(Q.Provider,{value:p,children:t})})}const Fe=x.forwardRef(Ee);function Ie(t){return t.value}function Me(t,r){return t.layout.min-r.layout.min}const D=50,W=25,Te=new Set(["auto","scroll"]),I=new WeakMap,M=new WeakMap;let F=null;function Oe(){if(F){const t=V(F,"y");t&&(M.delete(t),I.delete(t));const r=V(F,"x");r&&r!==t&&(M.delete(r),I.delete(r)),F=null}}function De(t,r){const i=getComputedStyle(t),u=r==="x"?i.overflowX:i.overflowY,s=t===document.body||t===document.documentElement;return Te.has(u)||s}function V(t,r){let i=t==null?void 0:t.parentElement;for(;i;){if(De(i,r))return i;i=i.parentElement}return null}function Ae(t,r,i){const u=r.getBoundingClientRect(),s=i==="x"?Math.max(0,u.left):Math.max(0,u.top),o=i==="x"?Math.min(window.innerWidth,u.right):Math.min(window.innerHeight,u.bottom),d=t-s,m=o-t;if(d<D){const c=1-d/D;return{amount:-W*c*c,edge:"start"}}else if(m<D){const c=1-m/D;return{amount:W*c*c,edge:"end"}}return{amount:0,edge:null}}function Re(t,r,i,u){if(!t)return;F=t;const s=V(t,i);if(!s)return;const o=r-(i==="x"?window.scrollX:window.scrollY),{amount:d,edge:m}=Ae(o,s,i);if(m===null){M.delete(s),I.delete(s);return}const c=M.get(s),h=s===document.body||s===document.documentElement;if(c!==m){if(!(m==="start"&&u<0||m==="end"&&u>0))return;M.set(s,m);const p=i==="x"?s.scrollWidth-(h?window.innerWidth:s.clientWidth):s.scrollHeight-(h?window.innerHeight:s.clientHeight);I.set(s,p)}if(d>0){const n=I.get(s);if((i==="x"?h?window.scrollX:s.scrollLeft:h?window.scrollY:s.scrollTop)>=n)return}i==="x"?h?window.scrollBy({left:d}):s.scrollLeft+=d:h?window.scrollBy({top:d}):s.scrollTop+=d}function _(t,r=0){return se(t)?t:ne(r)}function Be({children:t,style:r={},value:i,as:u="li",onDrag:s,onDragEnd:o,layout:d=!0,...m},c){const h=Y(()=>H[u]),n=x.useContext(Q),p={x:_(r.x),y:_(r.y)},y=te([p.x,p.y],([g,C])=>g||C?1:"unset"),{axis:j,registerItem:w,updateOrder:b,groupRef:S}=n;return e.jsx(h,{drag:j,...m,dragSnapToOrigin:!0,style:{...r,x:p.x,y:p.y,zIndex:y},layout:d,onDrag:(g,C)=>{const{velocity:E,point:l}=C,a=p[j].get();b(i,a,E[j]),Re(S.current,l[j],j,E[j]),s&&s(g,C)},onDragEnd:(g,C)=>{Oe(),o&&o(g,C)},onLayoutMeasure:g=>{w(i,g)},ref:c,ignoreStrict:!0,children:t})}const Pe=x.forwardRef(Be),ze=({page:t,onEdit:r})=>{var s;const i=t.slug==="home"?"/":`/${t.slug}`,u=((s=t.blocks)==null?void 0:s.length)??0;return e.jsx(H.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},transition:{duration:.2},layout:!0,children:e.jsxs(re,{className:"overflow-hidden transition-shadow hover:shadow-md",children:[e.jsxs(ie,{className:"flex items-center gap-4 p-4",children:[e.jsx("div",{className:"flex h-12 w-12 shrink-0 items-center justify-center rounded-lg bg-primary/10",children:e.jsx(oe,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h3",{className:"font-semibold",children:t.title}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["/",t.slug," · ",u," блоков"]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-0.5",children:["Обновлено:"," ",ve(new Date(t.updatedAt),{addSuffix:!0,locale:ye})]})]})]}),e.jsxs(le,{className:"flex gap-2 border-t p-4",children:[e.jsxs(v,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>r(t),children:[e.jsx(q,{className:"mr-1 h-3 w-3"}),"Редактировать"]}),e.jsx(v,{variant:"outline",size:"sm",asChild:!0,children:e.jsx(ae,{to:i,target:"_blank",children:e.jsx(je,{className:"h-3 w-3"})})})]})]})})},$={hero:"Hero",text:"Текст (Markdown)",cta:"CTA-блок",services:"Услуги",portfolio:"Портфолио",contacts:"Контакты",custom:"Произвольный блок"},Ve=({open:t,onOpenChange:r,block:i,mediaItems:u,onSave:s})=>{const[o,d]=x.useState({});if(x.useEffect(()=>{i&&d({...i.data??{}})},[i,t]),!i)return null;const m=n=>{n.preventDefault(),s(o),r(!1)},c=(n,p)=>d(y=>({...y,[n]:p})),h=()=>{switch(i.type){case"hero":return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"title",children:"Заголовок"}),e.jsx(L,{id:"title",value:String(o.title??""),onChange:n=>c("title",n.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"subtitle",children:"Подзаголовок"}),e.jsx(L,{id:"subtitle",value:String(o.subtitle??""),onChange:n=>c("subtitle",n.target.value)})]}),e.jsx(we,{label:"Изображение",value:String(o.imageId??""),onChange:n=>c("imageId",n),items:u,allowEmpty:!0})]});case"text":case"custom":return e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"markdown",children:"Markdown"}),e.jsx(z,{id:"markdown",value:String(o.markdown??""),onChange:n=>c("markdown",n.target.value),rows:8,className:"font-mono text-sm"})]});case"cta":return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"title",children:"Заголовок"}),e.jsx(L,{id:"title",value:String(o.title??""),onChange:n=>c("title",n.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"markdown",children:"Текст (Markdown)"}),e.jsx(z,{id:"markdown",value:String(o.markdown??""),onChange:n=>c("markdown",n.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"ctaLabel",children:"Подпись кнопки"}),e.jsx(L,{id:"ctaLabel",value:String(o.ctaLabel??""),onChange:n=>c("ctaLabel",n.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"ctaLink",children:"Ссылка"}),e.jsx(L,{id:"ctaLink",value:String(o.ctaLink??""),onChange:n=>c("ctaLink",n.target.value)})]})]});case"services":case"portfolio":case"contacts":return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"title",children:"Заголовок"}),e.jsx(L,{id:"title",value:String(o.title??""),onChange:n=>c("title",n.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"subtitle",children:"Подзаголовок"}),e.jsx(L,{id:"subtitle",value:String(o.subtitle??""),onChange:n=>c("subtitle",n.target.value)})]})]});default:return e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"markdown",children:"Содержимое (Markdown)"}),e.jsx(z,{id:"markdown",value:String(o.markdown??""),onChange:n=>c("markdown",n.target.value),rows:6})]})}};return e.jsx(A,{open:t,onOpenChange:r,children:e.jsxs(R,{className:"max-h-[90vh] overflow-y-auto sm:max-w-[500px]",children:[e.jsx(B,{children:e.jsx(P,{children:"Редактировать блок"})}),e.jsxs("form",{onSubmit:m,className:"space-y-4",children:[e.jsx("div",{className:"sticky top-0 z-10 flex justify-end bg-background/95 py-2 backdrop-blur-sm",children:e.jsx(v,{type:"submit",size:"sm",children:"Сохранить"})}),h(),e.jsxs(K,{className:"sticky bottom-0 bg-background pt-4",children:[e.jsx(v,{type:"button",variant:"outline",onClick:()=>r(!1),children:"Отмена"}),e.jsx(v,{type:"submit",children:"Сохранить"})]})]})]})})},Ge=()=>`b-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,He=({blocks:t,onChange:r,mediaItems:i})=>{const[u,s]=x.useState(null),[o,d]=x.useState(!1),[m,c]=x.useState("text"),[h,n]=x.useState(!1),[p,y]=x.useState(null),j=(l,a)=>{const f=[...t],k=l+a;k<0||k>=f.length||([f[l],f[k]]=[f[k],f[l]],r(f))},w=l=>{r(t.map(a=>a.id===l?{...a,visible:!a.visible}:a))},b=l=>{s(l),d(!0)},S=l=>{u&&(r(t.map(a=>a.id===u.id?{...a,data:l}:a)),d(!1),s(null))},g=()=>{const l={hero:{title:"",subtitle:""},text:{markdown:""},cta:{title:"",markdown:"",ctaLabel:"",ctaLink:""},services:{title:"Услуги",subtitle:""},portfolio:{title:"Портфолио",subtitle:""},contacts:{title:"Контакты",subtitle:""},custom:{markdown:""}},a={id:Ge(),type:m,visible:!0,data:l[m]};r([...t,a]),n(!1)},C=l=>{y(l)},E=()=>{p&&(r(t.filter(l=>l.id!==p.id)),y(null))};return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Блоки"}),e.jsxs(v,{type:"button",variant:"outline",size:"sm",onClick:()=>n(!0),children:[e.jsx(J,{className:"mr-1 h-4 w-4"}),"Добавить"]})]}),e.jsx(Fe,{axis:"y",values:t,onReorder:r,className:"space-y-2",children:e.jsx(U,{children:t.map((l,a)=>{var f;return e.jsxs(Pe,{value:l,className:"flex items-center gap-2 rounded-lg border bg-card p-3",children:[e.jsx("div",{className:"flex cursor-grab touch-none items-center text-muted-foreground",children:e.jsx(ke,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("p",{className:"text-sm font-medium truncate",children:[$[l.type],((f=l.data)==null?void 0:f.title)&&` — ${String(l.data.title)}`]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:l.visible?"Видим":"Скрыт"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(v,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>w(l.id),title:l.visible?"Скрыть":"Показать",children:l.visible?e.jsx(be,{className:"h-4 w-4"}):e.jsx(Ce,{className:"h-4 w-4"})}),e.jsx(v,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>j(a,-1),disabled:a===0,children:e.jsx(de,{className:"h-4 w-4"})}),e.jsx(v,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>j(a,1),disabled:a===t.length-1,children:e.jsx(ue,{className:"h-4 w-4"})}),e.jsx(v,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>b(l),children:e.jsx(q,{className:"h-4 w-4"})}),e.jsx(v,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:text-destructive",onClick:()=>C(l),children:e.jsx(me,{className:"h-4 w-4"})})]})]},l.id)})})}),e.jsx(Ve,{open:o,onOpenChange:d,block:u,mediaItems:i,onSave:S}),e.jsx(A,{open:h,onOpenChange:n,children:e.jsxs(R,{children:[e.jsx(B,{children:e.jsx(P,{children:"Добавить блок"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"Тип блока"}),e.jsxs(he,{value:m,onValueChange:l=>c(l),children:[e.jsx(xe,{children:e.jsx(fe,{})}),e.jsx(pe,{children:Object.entries($).map(([l,a])=>e.jsx(ge,{value:l,children:a},l))})]})]}),e.jsx(v,{onClick:g,children:"Добавить"})]})]})}),e.jsx(Ne,{open:!!p,onOpenChange:l=>!l&&y(null),title:"Удалить блок?",description:"Блок будет удалён со страницы.",confirmLabel:"Удалить",variant:"destructive",onConfirm:E})]})},X=t=>t.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,""),nt=()=>{const[t,r]=x.useState([]),[i,u]=x.useState([]),[s,o]=x.useState(null),[d,m]=x.useState(!1),[c,h]=x.useState(!1),[n,p]=x.useState(""),[y,j]=x.useState(""),[w,b]=x.useState(!0),S=x.useCallback(async()=>{try{b(!0);const[a,f]=await Promise.all([T.adminList({per_page:100}),ce.adminList({per_page:100})]);r(a.data),u(f.data)}catch(a){console.error("Failed to load pages:",a),O({title:"Ошибка",description:"Не удалось загрузить страницы.",variant:"destructive"})}finally{b(!1)}},[]);x.useEffect(()=>{S()},[S]);const g=async a=>{try{const f=await T.adminGet(Number(a.id));o(f),m(!0)}catch(f){console.error("Failed to load page:",f),o(a),m(!0)}},C=async a=>{if(s)try{await T.adminUpdate(Number(s.id),{blocks:a});const f={...s,blocks:a};o(f),r(t.map(k=>k.id===s.id?f:k)),O({title:"Сохранено",description:"Блоки страницы обновлены."})}catch(f){console.error("Failed to update blocks:",f),O({title:"Ошибка",description:"Не удалось сохранить блоки.",variant:"destructive"})}},E=async()=>{const a=y.trim()||X(n)||"page",f=n.trim()||"Новая страница";try{const k=await T.adminCreate({title:f,slug:a,blocks:[],status:"published"});h(!1),p(""),j(""),o(k),m(!0),await S()}catch(k){console.error("Failed to create page:",k),O({title:"Ошибка",description:"Не удалось создать страницу.",variant:"destructive"})}},l=Se(i);return w?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Загрузка..."})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Страницы"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Управление контентом страниц: блоки, порядок, видимость"})]}),e.jsxs(v,{onClick:()=>h(!0),className:"w-fit",children:[e.jsx(J,{className:"mr-2 h-4 w-4"}),"Новая страница"]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3",children:e.jsx(U,{mode:"popLayout",children:t.map(a=>e.jsx(ze,{page:a,onEdit:g},a.id))})}),e.jsx(A,{open:d,onOpenChange:m,children:e.jsxs(R,{className:"max-h-[90vh] max-w-2xl overflow-y-auto",children:[e.jsx(B,{children:e.jsx(P,{children:(s==null?void 0:s.title)??"Редактирование"})}),s&&e.jsx(He,{blocks:s.blocks,onChange:C,mediaItems:l})]})}),e.jsx(A,{open:c,onOpenChange:h,children:e.jsxs(R,{children:[e.jsx(B,{children:e.jsx(P,{children:"Новая страница"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"newTitle",children:"Название"}),e.jsx(L,{id:"newTitle",value:n,onChange:a=>{p(a.target.value),y||j(X(a.target.value))},placeholder:"О нас"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"newSlug",children:"Slug (URL)"}),e.jsx(L,{id:"newSlug",value:y,onChange:a=>j(a.target.value),placeholder:"about"})]})]}),e.jsxs(K,{children:[e.jsx(v,{variant:"outline",onClick:()=>h(!1),children:"Отмена"}),e.jsx(v,{onClick:E,disabled:!n.trim()&&!y.trim(),children:"Создать"})]})]})})]})};export{nt as default};
