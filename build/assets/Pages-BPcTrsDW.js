import{c as Y,r as p,k as ce,l as de,n as U,e as q,j as e,o as ue,p as me,q as he,B as w,L as xe,A as J,f as fe,g as W,h as H,t as z,m as pe}from"./index-BjXmukMB.js";import{u as G}from"./useMutation-C3238GB0.js";import{D as A,a as D,b as B,c as R,e as Z,I as E}from"./input-DAe4lIxK.js";import{L as C}from"./label-OMKLQviY.js";import{C as ge,b as je,d as ye}from"./card-DKzdbM1M.js";import{F as ve}from"./file-text-DZhRECcw.js";import{P as ee,T as we}from"./alert-dialog-CJtS-XBk.js";import{E as Ne}from"./external-link-BtB53YqC.js";import{f as Se,r as Ce}from"./ru-CVN3f-jD.js";import{C as be,e as ke,S as Le,a as Ee,b as Fe,c as Pe,d as Me,P as Oe}from"./Pagination-CxSeVkJc.js";import{T as _}from"./popover-DUD_p0tG.js";import{M as Te}from"./MediaSelect-CPHAmoR8.js";import{P as te,C as Ie}from"./ConfirmDialog-C1JTd1Vb.js";import{E as Ae}from"./eye-toMUAEHi.js";import{u as De}from"./use-resolved-media-C04fn5FG.js";import{L as Be}from"./index-D8B4_yNG.js";import"./check-b8t7-VoB.js";import"./image-CGAlF-Ci.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=Y("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=Y("GripVertical",[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]]),se=p.createContext(null);function _e(t,i,a,d){if(!d)return t;const n=t.findIndex(s=>s.value===i);if(n===-1)return t;const r=d>0?1:-1,c=t[n+r];if(!c)return t;const m=t[n],o=c.layout,x=ce(o.min,o.max,.5);return r===1&&m.layout.max+a>x||r===-1&&m.layout.min+a<x?de(t,n,n+r):t}function Ve({children:t,as:i="ul",axis:a="y",onReorder:d,values:n,...r},c){const m=U(()=>q[i]),o=[],x=p.useRef(!1),s=p.useRef(null),f={axis:a,groupRef:s,registerItem:(y,L)=>{const g=o.findIndex(v=>y===v.value);g!==-1?o[g].layout=L[a]:o.push({value:y,layout:L[a]}),o.sort(He)},updateOrder:(y,L,g)=>{if(x.current)return;const v=_e(o,y,L,g);o!==v&&(x.current=!0,d(v.map(We).filter(N=>n.indexOf(N)!==-1)))}};p.useEffect(()=>{x.current=!1});const b=y=>{s.current=y,typeof c=="function"?c(y):c&&(c.current=y)},j={overflowAnchor:"none",...r.style};return e.jsx(m,{...r,style:j,ref:b,ignoreStrict:!0,children:e.jsx(se.Provider,{value:f,children:t})})}const qe=p.forwardRef(Ve);function We(t){return t.value}function He(t,i){return t.layout.min-i.layout.min}const I=50,K=25,Ge=new Set(["auto","scroll"]),O=new WeakMap,T=new WeakMap;let M=null;function Ke(){if(M){const t=V(M,"y");t&&(T.delete(t),O.delete(t));const i=V(M,"x");i&&i!==t&&(T.delete(i),O.delete(i)),M=null}}function $e(t,i){const a=getComputedStyle(t),d=i==="x"?a.overflowX:a.overflowY,n=t===document.body||t===document.documentElement;return Ge.has(d)||n}function V(t,i){let a=t==null?void 0:t.parentElement;for(;a;){if($e(a,i))return a;a=a.parentElement}return null}function Qe(t,i,a){const d=i.getBoundingClientRect(),n=a==="x"?Math.max(0,d.left):Math.max(0,d.top),r=a==="x"?Math.min(window.innerWidth,d.right):Math.min(window.innerHeight,d.bottom),c=t-n,m=r-t;if(c<I){const o=1-c/I;return{amount:-K*o*o,edge:"start"}}else if(m<I){const o=1-m/I;return{amount:K*o*o,edge:"end"}}return{amount:0,edge:null}}function Xe(t,i,a,d){if(!t)return;M=t;const n=V(t,a);if(!n)return;const r=i-(a==="x"?window.scrollX:window.scrollY),{amount:c,edge:m}=Qe(r,n,a);if(m===null){T.delete(n),O.delete(n);return}const o=T.get(n),x=n===document.body||n===document.documentElement;if(o!==m){if(!(m==="start"&&d<0||m==="end"&&d>0))return;T.set(n,m);const f=a==="x"?n.scrollWidth-(x?window.innerWidth:n.clientWidth):n.scrollHeight-(x?window.innerHeight:n.clientHeight);O.set(n,f)}if(c>0){const s=O.get(n);if((a==="x"?x?window.scrollX:n.scrollLeft:x?window.scrollY:n.scrollTop)>=s)return}a==="x"?x?window.scrollBy({left:c}):n.scrollLeft+=c:x?window.scrollBy({top:c}):n.scrollTop+=c}function $(t,i=0){return me(t)?t:he(i)}function Ye({children:t,style:i={},value:a,as:d="li",onDrag:n,onDragEnd:r,layout:c=!0,...m},o){const x=U(()=>q[d]),s=p.useContext(se),f={x:$(i.x),y:$(i.y)},b=ue([f.x,f.y],([v,N])=>v||N?1:"unset"),{axis:j,registerItem:y,updateOrder:L,groupRef:g}=s;return e.jsx(x,{drag:j,...m,dragSnapToOrigin:!0,style:{...i,x:f.x,y:f.y,zIndex:b},layout:c,onDrag:(v,N)=>{const{velocity:P,point:l}=N,h=f[j].get();L(a,h,P[j]),Xe(g.current,l[j],j,P[j]),n&&n(v,N)},onDragEnd:(v,N)=>{Ke(),r&&r(v,N)},onLayoutMeasure:v=>{y(a,v)},ref:o,ignoreStrict:!0,children:t})}const Ue=p.forwardRef(Ye),Je=({page:t,onEdit:i})=>{var n;const a=t.slug==="home"?"/":`/${t.slug}`,d=((n=t.blocks)==null?void 0:n.length)??0;return e.jsx(q.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},transition:{duration:.2},layout:!0,children:e.jsxs(ge,{className:"overflow-hidden transition-shadow hover:shadow-md",children:[e.jsxs(je,{className:"flex items-center gap-4 p-4",children:[e.jsx("div",{className:"flex h-12 w-12 shrink-0 items-center justify-center rounded-lg bg-primary/10",children:e.jsx(ve,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h3",{className:"font-semibold",children:t.title}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["/",t.slug," · ",d," блоков"]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-0.5",children:["Обновлено:"," ",Se(new Date(t.updatedAt),{addSuffix:!0,locale:Ce})]})]})]}),e.jsxs(ye,{className:"flex gap-2 border-t p-4",children:[e.jsxs(w,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>i(t),children:[e.jsx(ee,{className:"mr-1 h-3 w-3"}),"Редактировать"]}),e.jsx(w,{variant:"outline",size:"sm",asChild:!0,children:e.jsx(xe,{to:a,target:"_blank",children:e.jsx(Ne,{className:"h-3 w-3"})})})]})]})})},Q={hero:"Hero",text:"Текст (Markdown)",cta:"CTA-блок",services:"Услуги",portfolio:"Портфолио",contacts:"Контакты",custom:"Произвольный блок"},Ze=({open:t,onOpenChange:i,block:a,mediaItems:d,onSave:n})=>{const[r,c]=p.useState({});if(p.useEffect(()=>{a&&c({...a.data??{}})},[a,t]),!a)return null;const m=s=>{s.preventDefault(),n(r),i(!1)},o=(s,f)=>c(b=>({...b,[s]:f})),x=()=>{switch(a.type){case"hero":return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"title",children:"Заголовок"}),e.jsx(E,{id:"title",value:String(r.title??""),onChange:s=>o("title",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"subtitle",children:"Подзаголовок"}),e.jsx(E,{id:"subtitle",value:String(r.subtitle??""),onChange:s=>o("subtitle",s.target.value)})]}),e.jsx(Te,{label:"Изображение",value:String(r.imageId??""),onChange:s=>o("imageId",s),items:d,allowEmpty:!0})]});case"text":case"custom":return e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"markdown",children:"Markdown"}),e.jsx(_,{id:"markdown",value:String(r.markdown??""),onChange:s=>o("markdown",s.target.value),rows:8,className:"font-mono text-sm"})]});case"cta":return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"title",children:"Заголовок"}),e.jsx(E,{id:"title",value:String(r.title??""),onChange:s=>o("title",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"markdown",children:"Текст (Markdown)"}),e.jsx(_,{id:"markdown",value:String(r.markdown??""),onChange:s=>o("markdown",s.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"ctaLabel",children:"Подпись кнопки"}),e.jsx(E,{id:"ctaLabel",value:String(r.ctaLabel??""),onChange:s=>o("ctaLabel",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"ctaLink",children:"Ссылка"}),e.jsx(E,{id:"ctaLink",value:String(r.ctaLink??""),onChange:s=>o("ctaLink",s.target.value)})]})]});case"services":case"portfolio":case"contacts":return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"title",children:"Заголовок"}),e.jsx(E,{id:"title",value:String(r.title??""),onChange:s=>o("title",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"subtitle",children:"Подзаголовок"}),e.jsx(E,{id:"subtitle",value:String(r.subtitle??""),onChange:s=>o("subtitle",s.target.value)})]})]});default:return e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"markdown",children:"Содержимое (Markdown)"}),e.jsx(_,{id:"markdown",value:String(r.markdown??""),onChange:s=>o("markdown",s.target.value),rows:6})]})}};return e.jsx(A,{open:t,onOpenChange:i,children:e.jsxs(D,{className:"max-h-[90vh] overflow-y-auto sm:max-w-[500px]",children:[e.jsx(B,{children:e.jsx(R,{children:"Редактировать блок"})}),e.jsxs("form",{onSubmit:m,className:"space-y-4",children:[e.jsx("div",{className:"sticky top-0 z-10 flex justify-end bg-background/95 py-2 backdrop-blur-sm",children:e.jsx(w,{type:"submit",size:"sm",children:"Сохранить"})}),x(),e.jsxs(Z,{className:"sticky bottom-0 bg-background pt-4",children:[e.jsx(w,{type:"button",variant:"outline",onClick:()=>i(!1),children:"Отмена"}),e.jsx(w,{type:"submit",children:"Сохранить"})]})]})]})})},et=()=>`b-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,tt=({blocks:t,onChange:i,mediaItems:a})=>{const[d,n]=p.useState(null),[r,c]=p.useState(!1),[m,o]=p.useState("text"),[x,s]=p.useState(!1),[f,b]=p.useState(null),j=(l,h)=>{const k=[...t],S=l+h;S<0||S>=k.length||([k[l],k[S]]=[k[S],k[l]],i(k))},y=l=>{i(t.map(h=>h.id===l?{...h,visible:!h.visible}:h))},L=l=>{n(l),c(!0)},g=l=>{d&&(i(t.map(h=>h.id===d.id?{...h,data:l}:h)),c(!1),n(null))},v=()=>{const l={hero:{title:"",subtitle:""},text:{markdown:""},cta:{title:"",markdown:"",ctaLabel:"",ctaLink:""},services:{title:"Услуги",subtitle:""},portfolio:{title:"Портфолио",subtitle:""},contacts:{title:"Контакты",subtitle:""},custom:{markdown:""}},h={id:et(),type:m,visible:!0,data:l[m]};i([...t,h]),s(!1)},N=l=>{b(l)},P=()=>{f&&(i(t.filter(l=>l.id!==f.id)),b(null))};return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Блоки"}),e.jsxs(w,{type:"button",variant:"outline",size:"sm",onClick:()=>s(!0),children:[e.jsx(te,{className:"mr-1 h-4 w-4"}),"Добавить"]})]}),e.jsx(qe,{axis:"y",values:t,onReorder:i,className:"space-y-2",children:e.jsx(J,{children:t.map((l,h)=>{var k;return e.jsxs(Ue,{value:l,className:"flex items-center gap-2 rounded-lg border bg-card p-3",children:[e.jsx("div",{className:"flex cursor-grab touch-none items-center text-muted-foreground",children:e.jsx(ze,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("p",{className:"text-sm font-medium truncate",children:[Q[l.type],((k=l.data)==null?void 0:k.title)&&` — ${String(l.data.title)}`]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:l.visible?"Видим":"Скрыт"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(w,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>y(l.id),title:l.visible?"Скрыть":"Показать",children:l.visible?e.jsx(Ae,{className:"h-4 w-4"}):e.jsx(Re,{className:"h-4 w-4"})}),e.jsx(w,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>j(h,-1),disabled:h===0,children:e.jsx(be,{className:"h-4 w-4"})}),e.jsx(w,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>j(h,1),disabled:h===t.length-1,children:e.jsx(ke,{className:"h-4 w-4"})}),e.jsx(w,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>L(l),children:e.jsx(ee,{className:"h-4 w-4"})}),e.jsx(w,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:text-destructive",onClick:()=>N(l),children:e.jsx(we,{className:"h-4 w-4"})})]})]},l.id)})})}),e.jsx(Ze,{open:r,onOpenChange:c,block:d,mediaItems:a,onSave:g}),e.jsx(A,{open:x,onOpenChange:s,children:e.jsxs(D,{children:[e.jsx(B,{children:e.jsx(R,{children:"Добавить блок"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Тип блока"}),e.jsxs(Le,{value:m,onValueChange:l=>o(l),children:[e.jsx(Ee,{children:e.jsx(Fe,{})}),e.jsx(Pe,{children:Object.entries(Q).map(([l,h])=>e.jsx(Me,{value:l,children:h},l))})]})]}),e.jsx(w,{onClick:v,children:"Добавить"})]})]})}),e.jsx(Ie,{open:!!f,onOpenChange:l=>!l&&b(null),title:"Удалить блок?",description:"Блок будет удалён со страницы.",confirmLabel:"Удалить",variant:"destructive",onConfirm:P})]})},X=t=>t.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,""),vt=()=>{const t=fe(),[i,a]=p.useState(1),[d,n]=p.useState(25),[r,c]=p.useState(null),[m,o]=p.useState(!1),[x,s]=p.useState(!1),[f,b]=p.useState(""),[j,y]=p.useState(""),L={per_page:d,page:i},{data:g,isLoading:v}=W({queryKey:["pages","admin",L],queryFn:()=>z.adminList(L),refetchOnWindowFocus:!1,retry:1}),{data:N,isLoading:P}=W({queryKey:["media","admin",{per_page:100}],queryFn:()=>pe.adminList({per_page:100}),refetchOnWindowFocus:!1,retry:1}),l=(g==null?void 0:g.data)||[],h=(N==null?void 0:N.data)||[],k=v||P,S=g?{currentPage:g.current_page,lastPage:g.last_page,perPage:g.per_page,total:g.total}:null,ne=G({mutationFn:({title:u,slug:F})=>z.adminCreate({title:u,slug:F,blocks:[],status:"published"}),onSuccess:u=>{t.invalidateQueries({queryKey:["pages","admin"]}),H.success("Страница создана"),s(!1),b(""),y(""),c(u),o(!0)}}),ae=G({mutationFn:({id:u,blocks:F})=>z.adminUpdate(u,{blocks:F}),onSuccess:(u,F)=>{t.invalidateQueries({queryKey:["pages","admin"]}),r&&r.id===String(F.id)&&c({...r,blocks:F.blocks}),H.success("Блоки страницы обновлены")}}),re=u=>{c(u),o(!0)},ie=u=>{r&&ae.mutate({id:Number(r.id),blocks:u})},le=()=>{const u=j.trim()||X(f)||"page",F=f.trim()||"Новая страница";ne.mutate({title:F,slug:u})},oe=De(h);return k?e.jsxs("div",{className:"flex items-center justify-center min-h-screen",children:[e.jsx(Be,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("div",{className:"text-sm text-muted-foreground ml-3",children:"Загрузка страниц..."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Страницы"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Управление контентом страниц: блоки, порядок, видимость"})]}),e.jsxs(w,{onClick:()=>s(!0),className:"w-fit",children:[e.jsx(te,{className:"mr-2 h-4 w-4"}),"Новая страница"]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3",children:e.jsx(J,{mode:"popLayout",children:l.map(u=>e.jsx(Je,{page:u,onEdit:re},u.id))})}),l.length===0&&!k&&e.jsx("p",{className:"py-12 text-center text-sm text-muted-foreground",children:(S==null?void 0:S.total)===0?"Нет страниц. Добавьте первую.":"Нет результатов."}),S&&e.jsx(Oe,{currentPage:S.currentPage,lastPage:S.lastPage,perPage:S.perPage,total:S.total,onPageChange:u=>{a(u),window.scrollTo({top:0,behavior:"smooth"})},onPerPageChange:u=>{n(u),a(1)}}),e.jsx(A,{open:m,onOpenChange:o,children:e.jsxs(D,{className:"max-h-[90vh] max-w-2xl overflow-y-auto",children:[e.jsx(B,{children:e.jsx(R,{children:(r==null?void 0:r.title)??"Редактирование"})}),r&&e.jsx(tt,{blocks:r.blocks,onChange:ie,mediaItems:oe})]})}),e.jsx(A,{open:x,onOpenChange:s,children:e.jsxs(D,{children:[e.jsx(B,{children:e.jsx(R,{children:"Новая страница"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"newTitle",children:"Название"}),e.jsx(E,{id:"newTitle",value:f,onChange:u=>{b(u.target.value),j||y(X(u.target.value))},placeholder:"О нас"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"newSlug",children:"Slug (URL)"}),e.jsx(E,{id:"newSlug",value:j,onChange:u=>y(u.target.value),placeholder:"about"})]})]}),e.jsxs(Z,{children:[e.jsx(w,{variant:"outline",onClick:()=>s(!1),children:"Отмена"}),e.jsx(w,{onClick:le,disabled:!f.trim()&&!j.trim(),children:"Создать"})]})]})})]})};export{vt as default};
